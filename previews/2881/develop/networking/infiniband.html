<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Infiniband | oVirt</title>
<meta name="generator" content="Jekyll v3.9.2" />
<meta property="og:title" content="Infiniband" />
<meta name="author" content="Markus Stockhausen" />
<meta property="og:locale" content="en" />
<meta name="description" content="oVirt is a free open-source virtualization solution for your entire enterprise" />
<meta property="og:description" content="oVirt is a free open-source virtualization solution for your entire enterprise" />
<link rel="canonical" href="https://ovirt.github.io/ovirt-site/previews/2881/develop/networking/infiniband.html" />
<meta property="og:url" content="https://ovirt.github.io/ovirt-site/previews/2881/develop/networking/infiniband.html" />
<meta property="og:site_name" content="oVirt" />
<meta property="og:type" content="website" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Infiniband" />
<meta name="twitter:site" content="@ovirt" />
<meta name="twitter:creator" content="@Markus Stockhausen" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"WebPage","author":{"@type":"Person","name":"Markus Stockhausen"},"description":"oVirt is a free open-source virtualization solution for your entire enterprise","headline":"Infiniband","publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"https://ovirt.github.io/ovirt-site/previews/2881/images/logo.svg"},"name":"Markus Stockhausen"},"url":"https://ovirt.github.io/ovirt-site/previews/2881/develop/networking/infiniband.html"}</script>
<!-- End Jekyll SEO tag -->

  <meta name="viewport" content="initial-scale=1.0,user-scalable=no,maximum-scale=1,width=device-width">
  <link rel="stylesheet" href="/ovirt-site/previews/2881/stylesheets/fonts.css" />
  <link rel='stylesheet' href='https://fonts.googleapis.com/css?family=Open+Sans'>
  <link rel="stylesheet" href="/ovirt-site/previews/2881/stylesheets/application.css" />
  <link rel="stylesheet" href="/ovirt-site/previews/2881/stylesheets/print.css" media="print" />
  <link rel="stylesheet" href="/ovirt-site/previews/2881/stylesheets/coderay.css" media="screen" />
  <link rel="stylesheet" href="/ovirt-site/previews/2881/stylesheets/asciidoc.css" />
  <script src="/ovirt-site/previews/2881/javascripts/vendor/jquery.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/2881/javascripts/vendor/bootstrap.min.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/2881/javascripts/vendor/bootstrap-sortable.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/2881/javascripts/vendor/moment.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/2881/javascripts/vendor/fullcalendar/fullcalendar.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/2881/javascripts/lib/cal-widget.js" type="text/javascript"></script>
  <link href='/ovirt-site/previews/2881/favicon.ico' rel='shortcut icon' sizes='36x36 24x24 16x16' type='image/x-icon'/>
<link href='/ovirt-site/previews/2881/favicon.png' rel='icon' sizes='196x196' type='image/png'/>
<meta content='/ovirt-site/previews/2881/mstile-icon-128x128.png' name='msapplication-TileImage'/>
<meta content='transparent' name='msapplication-TileColor'/>
<link href='/ovirt-site/previews/2881/manifest.webmanifest' rel='manifest'/>
<meta content='/ovirt-site/previews/2881/browserconfig.xml' name='msapplication-config'/>
</head>
<body class=""><header class='masthead hidden-print' id='branding' role='banner'><section class='hgroup'></section><div id='access'><nav id="mainNav" class="navbar navbar-fixed-top affix-top">  <div class="container">    <div class="col-sm-2 navbar-header">      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#menu_id0980fddf">        <span class="sr-only">Toggle navigation</span>        <span>Menu</span>        <span class="fa fa-bars"></span>      </button>      <a class="navbar-brand" href="/ovirt-site/previews/2881/">        <img id="logo" alt="oVirt" src="/ovirt-site/previews/2881/images/logo.svg">      </a>    </div>    <!-- Collect the nav links, forms, and other content for toggling -->    <div class="col-sm-10">      <div class="navbar-collapse collapse" id="menu_id0980fddf">        <ul class="nav navbar-nav">          <li class="hidden active">            <a href="#page-wrap"></a>          </li><li role='menuitem'>  <a href='/ovirt-site/previews/2881/download/'>Download</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/2881/documentation/'>Documentation</a></li><li class='active' role='menuitem'>  <a href='/ovirt-site/previews/2881/develop/'>Developers</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/2881/community/'>Community</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/2881//lists.ovirt.org/archives/'>Forum</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/2881//blogs.ovirt.org/'>Blog</a></li>              </ul>          </div>          <!-- /.navbar-collapse -->      </div>      <!-- /.container-fluid -->    </div>  </div></nav></div></header><main id="page-wrap" class="page-wrap" aria-label="Content">
      <section id="page" class="page">
        <!-- adapted from https://github.com/git-no/jekyll-breadcrumbs -->
<nav class="breadcrumbs bootstrap hidden-sm-down" aria-label="breadcrumb">

   <ol class="breadcrumb list-unstyled" vocab="http://schema.org/" typeof="BreadcrumbList">

      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/2881/">
              <span property="name"></span>
              <meta property="position" content="1" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/2881/develop/">
              <span property="name">Developers Community</span>
              <meta property="position" content="2" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/2881/develop/networking/">
              <span property="name">Networking</span>
              <meta property="position" content="3" />
           </a>
        </li>
      
        
        
          

   </ol>

</nav>

        
          
            <header class="post-header col-md-4 pad-sides well well-lg">
              <h2 class="post-title entry-title">Authors:</h2>
              <div class="post-meta">
                
                  
                  
                  
                  <div class="blogger_avatar">
                    <img
                      src="https://secure.gravatar.com/avatar/b64af159420782a0d7dc29c95d3e80c6?s=32&amp;d=mm&amp;r=g"
                      srcset="https://secure.gravatar.com/avatar/b64af159420782a0d7dc29c95d3e80c6?s=64&amp;d=mm&amp;r=g 2x"
                      class="avatar avatar-32 photo"
                      height="32"
                      width="32"
                      loading="lazy">
                  </div>
                  <span class="byline">
                    <section class="entry-meta">
                      
                        <p><span class="author vcard">Markus Stockhausen</span></p>
                      
                    </section>
                  </span>
                
                  
                  
                  
                  <div class="blogger_avatar">
                    <img
                      src="https://secure.gravatar.com/avatar/d1444ce9dae56ad479be1aa9e2b217bd?s=32&amp;d=mm&amp;r=g"
                      srcset="https://secure.gravatar.com/avatar/d1444ce9dae56ad479be1aa9e2b217bd?s=64&amp;d=mm&amp;r=g 2x"
                      class="avatar avatar-32 photo"
                      height="32"
                      width="32"
                      loading="lazy">
                  </div>
                  <span class="byline">
                    <section class="entry-meta">
                      
                        <p><span class="author vcard">Sven Kieske</span></p>
                      
                    </section>
                  </span>
                
                </div>
            </header>
          
        
        <section id="content" class="content container">
          <div class='alert alert-warning'>This developer documentation is <strong>outdated</strong>, but provides historical context.<br><br>It is <strong>not</strong> user documentation and should not be treated as such.<br><br><a href='/ovirt-site/previews/2881/documentation/'>Documentation is available here.</a></div>

<h1 id="infiniband">Infiniband</h1>

<h2 id="introduction">Introduction</h2>

<p>Although targeted at high performance computing Infiniband networks may be a quite cheap alternative to 10 Gigabit Ethernet. Nevertheless it is not an out of the box experience. So your expectations should never be to get close to wire speed but to be happy with every MB/s that you can reach beyond Giagbit Ethernet. This page should give a first impression for the interested reader what problems one might encounter.</p>

<h2 id="ipoib">IPoIB</h2>

<p>IP over Infiniband (IPoIB) is an encapsulation of TCP packets inside Infiniband packets. That adds a lot of overhead but combined with an NFS server it is the easiest setup that is fully supported within OVirt.</p>

<h3 id="hypervisor-node-setup">Hypervisor node setup</h3>

<p>On the hypervisor node you have to load the IPoIB required modules. These consist of the driver of your card, the transport and a managing module. For Mellanox ConnectX cards create a /etc/modules-load.d/ib.conf with the following lines</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  mlx4_ib
  ib_ipoib
  ib_umad
</code></pre></div></div>

<p>After loading these modules you should see an Infiniband interface ib0 inside Ovirt (additionally ib1 if you have a two port card). Add a new network as usual and assign it with a static IP to the interface.</p>

<h3 id="issue-mellanox-tso-bug">Issue: Mellanox TSO bug</h3>

<p>The kernel advertises TSO for Mellanox ConnectX cards although it is not supported. Therefore the hardware creates corrupt IP fragments on sender side during large requests and the receiving client cannot use LRO. The result of a lengthy discussion is stated <a href="http://www.spinics.net/lists/linux-rdma/msg17787.html">here</a>. So check if your Mellanox card has revision <strong>a0</strong>. Here an example of a non TSO compatible card:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  lspci | grep Mellanox
  03:00.0 InfiniBand: Mellanox Technologies MT25418 [ConnectX VPI PCIe 2.0 2.5GT/s - IB DDR / 10GigE] (rev a0)
</code></pre></div></div>

<p>If you have such an old card disable TSO and make that setting permanent in some startup script.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  ` isOldCard=`lspci | grep Mellanox | grep a0 | wc -l` `
  if [ $isOldCard -gt 0 ]; then
    ethtool -K ib0 tso off
    ethtool -K ib1 tso off
  fi
</code></pre></div></div>

<h3 id="issue-old-hardware-and-mtu-2044">Issue: Old hardware and MTU 2044</h3>

<p>If you are running on old switch hardware than your maximum IPoIB MTU will be limited to 2044 bytes. That is no problem at all - at least on switch level. On your NFS server and hypervisor nodes this can result in unneccessary CPU cycles and reduced throughput. Once again a reference to a <a href="http://www.spinics.net/lists/linux-rdma/msg15133.html">discussion thread</a>.</p>

<p>If you are not afraid of compiling kernels yourself and you know what you are doing than you can benefit from a dirty hack that limits the IPoIB MTU inside the kernel to 3072 bytes. With that receive operations will be served within a single 4K page and unneccessary copy operations can be avoided. Add the following modification to ipoib_add_port() in drivers/infiniband/ulp/ipoib/ipoib_main.c:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    ...
    if (!ib_query_port(hca, port, &amp;attr))
      /* Limit max MTU to 3KB                                 */
      /* priv-&gt;max_ib_mtu = ib_mtu_enum_to_int(attr.max_mtu); */
      priv-&gt;max_ib_mtu = 3072;
    else {
    ...
</code></pre></div></div>

<h2 id="nfs-over-rdma">NFS over RDMA</h2>

<p>In this setup NFS sunrpc layer driectly accesses the basic infiniband mechanisms to exchange data between NFS server and client. The configuration is explained <a href="https://www.kernel.org/doc/Documentation/filesystems/nfs/nfs-rdma.txt">here</a> and might have some bugs:</p>

<ul>
  <li><a href="https://bugzilla.redhat.com/show_bug.cgi?id=1046011">Cannot read more than 812 bytes from NFS server file</a>: The bug can occur between kernels 3.7 and 3.13. It should be fixed with <a href="http://article.gmane.org/gmane.linux.nfs/60953">this commit</a></li>
  <li><a href="http://www.mail-archive.com/linux-rdma@vger.kernel.org/msg14145.html">NFS crashes</a>: Not yet tested/observed.</li>
</ul>

<p>At the moment OVirt does not allow to mount NFS shares over RDMA. So the only option is to modify the mount operation in /usr/share/vdsm/storage/storageServer.py yourself.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  ...
  class NFSConnection(object):
    DEFAULT_OPTIONS = ["soft", "nosharecache", "rdma", "port=20049"]
  ...
</code></pre></div></div>

<p>A reqeust for enhancement of OVirt has been created as Redhat Bug <a href="https://bugzilla.redhat.com/show_bug.cgi?id=1057043">1057043</a></p>

<h2 id="srp">SRP</h2>

<p>SCSI Remote Protocol can be compared to iSCSI and comes close to wire speed. It is not yet implemented in OVirt.</p>



        </section>
      </section>
    </main>

    <script src="/ovirt-site/previews/2881/javascripts/lib/headings_anchors.js" type="text/javascript"></script><footer class='text-center' id='footer'><hr class='visible-print'><ul class='footer-nav-list'><li><a href='/ovirt-site/previews/2881/privacy-policy.html' target='_blank' title='Privacy policy'>Privacy policy</a></li><li><a href='/ovirt-site/previews/2881/community/about.html' target='_blank' title='About'>About</a></li><li><a href='/ovirt-site/previews/2881/general-disclaimer.html' target='_blank' title='Disclaimers'>Disclaimers</a></li></ul>&copy; 2013&ndash;2022 oVirt<div class='edit-this-page'><a href='https://github.com/oVirt/ovirt-site/issues/new?labels=content&amp;title=Issue:%20/develop/networking/infiniband.html&amp;template=' target='_blank' title='Report an issue'><i class="icon fab fa-github"></i>Report an issue with this page</a></div><div class='edit-this-page'><a href='https://github.com/oVirt/ovirt-site/edit/master/source/develop/networking/infiniband.md' target='_blank' title='Edit this page'><i class="icon fab fa-github"></i>Edit this page</a></div></footer></body>

</html>
