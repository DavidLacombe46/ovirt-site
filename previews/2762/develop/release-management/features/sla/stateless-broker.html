<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <!-- Begin Jekyll SEO tag v2.7.1 -->
<title>Stateless Hosted Engine broker | oVirt</title>
<meta name="generator" content="Jekyll v3.9.1" />
<meta property="og:title" content="Stateless Hosted Engine broker" />
<meta property="og:locale" content="en" />
<meta name="description" content="oVirt is a free open-source virtualization solution for your entire enterprise" />
<meta property="og:description" content="oVirt is a free open-source virtualization solution for your entire enterprise" />
<link rel="canonical" href="https://ovirt.github.io/ovirt-site/previews/2762/develop/release-management/features/sla/stateless-broker.html" />
<meta property="og:url" content="https://ovirt.github.io/ovirt-site/previews/2762/develop/release-management/features/sla/stateless-broker.html" />
<meta property="og:site_name" content="oVirt" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Stateless Hosted Engine broker" />
<meta name="twitter:site" content="@ovirt" />
<script type="application/ld+json">
{"publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"https://ovirt.github.io/ovirt-site/previews/2762/images/logo.svg"}},"description":"oVirt is a free open-source virtualization solution for your entire enterprise","@type":"WebPage","headline":"Stateless Hosted Engine broker","url":"https://ovirt.github.io/ovirt-site/previews/2762/develop/release-management/features/sla/stateless-broker.html","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->

  <meta name="viewport" content="initial-scale=1.0,user-scalable=no,maximum-scale=1,width=device-width">
  <link rel="stylesheet" href="/ovirt-site/previews/2762/stylesheets/fonts.css" />
  <link rel='stylesheet' href='https://fonts.googleapis.com/css?family=Open+Sans'>
  <link rel="stylesheet" href="/ovirt-site/previews/2762/stylesheets/application.css" />
  <link rel="stylesheet" href="/ovirt-site/previews/2762/stylesheets/print.css" media="print" />
  <link rel="stylesheet" href="/ovirt-site/previews/2762/stylesheets/coderay.css" media="screen" />
  <link rel="stylesheet" href="/ovirt-site/previews/2762/stylesheets/asciidoc.css" />
  <script src="/ovirt-site/previews/2762/javascripts/vendor/jquery.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/2762/javascripts/vendor/bootstrap.min.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/2762/javascripts/vendor/bootstrap-sortable.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/2762/javascripts/vendor/moment.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/2762/javascripts/vendor/fullcalendar/fullcalendar.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/2762/javascripts/lib/cal-widget.js" type="text/javascript"></script>
  <!-- Begin Jekyll Favicon tag v0.2.9 -->
<!-- Classic -->
<link rel="shortcut icon" href="/ovirt-site/previews/2762/favicon.ico">
<link rel="icon" sizes="48x48 32x32 16x16" href="/ovirt-site/previews/2762/favicon.ico">
  <link rel="icon" sizes="16x16" type="image/png" href="/ovirt-site/previews/2762/images/favicon-16x16.png">
  <link rel="icon" sizes="32x32" type="image/png" href="/ovirt-site/previews/2762/images/favicon-32x32.png">
  <link rel="icon" sizes="64x64" type="image/png" href="/ovirt-site/previews/2762/images/favicon-64x64.png">
  <link rel="icon" sizes="144x144" type="image/png" href="/ovirt-site/previews/2762/images/favicon-144x144.png">
<!-- Safari -->
  <link rel="apple-touch-icon" sizes="57x57" href="/ovirt-site/previews/2762/images/favicon-57x57.png">
  <link rel="apple-touch-icon" sizes="76x76" href="/ovirt-site/previews/2762/images/favicon-76x76.png">
  <link rel="apple-touch-icon" sizes="120x120" href="/ovirt-site/previews/2762/images/favicon-120x120.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/ovirt-site/previews/2762/images/favicon-152x152.png">
  <link rel="apple-touch-icon" sizes="167x167" href="/ovirt-site/previews/2762/images/favicon-167x167.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/ovirt-site/previews/2762/images/favicon-180x180.png">
<!-- Chrome -->
  <link rel="icon" sizes="192x192" href="/ovirt-site/previews/2762/images/favicon-192x192.png">
  <link rel="icon" sizes="96x96" href="/ovirt-site/previews/2762/images/favicon-96x96.png">
  <link rel="icon" sizes="48x48" href="/ovirt-site/previews/2762/images/favicon-48x48.png">
<link rel="manifest" href="/ovirt-site/previews/2762/manifest.webmanifest">
<!-- IE -->
<meta name="msapplication-TileColor" content="#ffffff">
<meta name="msapplication-TileImage" content="/ovirt-site/previews/2762/images/favicon-144x144.png">
<meta name='msapplication-config' content="/ovirt-site/previews/2762/browserconfig.xml">
<!-- End Jekyll Favicon tag -->
</head>
<body class=""><header class='masthead hidden-print' id='branding' role='banner'><section class='hgroup'></section><div id='access'><nav id="mainNav" class="navbar navbar-fixed-top affix-top">  <div class="container">    <div class="col-sm-2 navbar-header">      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#menu_id0980fddf">        <span class="sr-only">Toggle navigation</span>        <span>Menu</span>        <span class="fa fa-bars"></span>      </button>      <a class="navbar-brand" href="/ovirt-site/previews/2762/">        <img id="logo" alt="oVirt" src="/ovirt-site/previews/2762/images/logo.svg">      </a>    </div>    <!-- Collect the nav links, forms, and other content for toggling -->    <div class="col-sm-10">      <div class="navbar-collapse collapse" id="menu_id0980fddf">        <ul class="nav navbar-nav">          <li class="hidden active">            <a href="#page-wrap"></a>          </li><li role='menuitem'>  <a href='/ovirt-site/previews/2762/download/'>Download</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/2762/documentation/'>Documentation</a></li><li class='active' role='menuitem'>  <a href='/ovirt-site/previews/2762/develop/'>Developers</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/2762/community/'>Community</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/2762//lists.ovirt.org/archives/'>Forum</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/2762//blogs.ovirt.org/'>Blog</a></li>              </ul>          </div>          <!-- /.navbar-collapse -->      </div>      <!-- /.container-fluid -->    </div>  </div></nav></div></header><main id="page-wrap" class="page-wrap" aria-label="Content">
      <section id="page" class="page">
        <!-- adapted from https://github.com/git-no/jekyll-breadcrumbs -->
<nav class="breadcrumbs bootstrap hidden-sm-down" aria-label="breadcrumb">

   <ol class="breadcrumb list-unstyled" vocab="http://schema.org/" typeof="BreadcrumbList">

      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/2762/">
              <span property="name"></span>
              <meta property="position" content="1" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/2762/develop/">
              <span property="name">Developers Community</span>
              <meta property="position" content="2" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/2762/develop/release-management/">
              <span property="name">Release Management</span>
              <meta property="position" content="3" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/2762/develop/release-management/features/">
              <span property="name">Features (Design documents)</span>
              <meta property="position" content="4" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/2762/develop/release-management/features/sla/">
              <span property="name">Sla</span>
              <meta property="position" content="5" />
           </a>
        </li>
      
        
        
          

   </ol>

</nav>

        
          
            <header class="post-header col-md-4 pad-sides well well-lg">
              <h2 class="post-title entry-title">Authors:</h2>
              <header class="post-meta">
                
                  
                  
                  
                  <div class="blogger_avatar">
                    <img
                      src="https://secure.gravatar.com/avatar/a47850263e36b9e8a35dcedf316a14ad?s=32&amp;d=mm&amp;r=g"
                      srcset="https://secure.gravatar.com/avatar/a47850263e36b9e8a35dcedf316a14ad?s=64&amp;d=mm&amp;r=g 2x"
                      class="avatar avatar-32 photo"
                      height="32"
                      width="32"
                      loading="lazy">
                  </div>
                  <span class="byline">
                    <section class="entry-meta">
                      
                        <p><span class="author vcard">Denis Chaplygin</span></p>
                      
                    </section>
                  </span>
                
              </header>
            </header>
          
        
        <section id="content" class="content container">
          <div class='alert alert-warning'>Feature pages are design documents that developers have created while collaborating on oVirt.<br><br>Most of them are&nbsp;<strong>outdated</strong>, but provide historical design context.<br><br>They are&nbsp;<strong>not</strong>&nbsp;user documentation and should not be treated as such.<br><br><a href='/ovirt-site/previews/2762/documentation/'>Documentation is available here.</a></div>

<h1 id="stateless-hosted-engine-broker">Stateless Hosted Engine broker</h1>

<p><strong>Stateless Hosted Engine broker</strong></p>

<h2 id="summary">Summary</h2>

<p>Replacing custom made agent-broker RPC implementation with python’s standard xmlrpc</p>

<h2 id="owners">Owners</h2>

<h4 id="initial-design-and-implementation">Initial design and implementation</h4>

<ul>
  <li>Name: Denis Chaplygin (dchaplyg)</li>
</ul>

<h4 id="maintainers">Maintainers</h4>

<ul>
  <li>Name: Denis Chaplygin (dchaplyg)</li>
  <li>Name: Martin Sivak (msivak) msivak@redhat.com</li>
</ul>

<h2 id="current-status">Current status</h2>

<ul>
  <li>Target Release: 4.2</li>
  <li>Status: Done</li>
  <li>Last updated: December 11, 2017</li>
</ul>

<h2 id="detailed-description">Detailed Description</h2>

<p>With Hosted Engine operation expirience we realized, that some planned features was neither ever used nor even implemented. One of those features is ability of
the engine to handle several storage domains for several agents.</p>

<p>Special stateful agent-broker RPC protocol was developed to enable those abilities. Unfortunately, it is useless now and hard to maintain. Problems with
maintaining and extension result to moving part ob broker’s job to the agent.</p>

<p>Therefore, as most part of that functionality is not needed, we can get rid of multi-agent support and custom RPC protocol. To do that we need:</p>

<ol>
  <li>Make broker stateless, i.e. support just a single agent/storage. We need to replace <code class="language-plaintext highlighter-rouge">_backends</code> array with a single <code class="language-plaintext highlighter-rouge">backend</code> var in StorageBroker and remove mandatory <code class="language-plaintext highlighter-rouge">client</code> parameter. Same applies to the ConnectioHanlder calss: we do not need to keep client id in the handler’s thread and do not need to pass it to the StorageBroker methods anymore. On the other hand, we still need to set storage info in a first call after connection.</li>
  <li>Enable broker to get storage information from config on start up. Biggest part of the <code class="language-plaintext highlighter-rouge">_initialize_broker</code> code should be moved from agetn to StorageBroker.<strong>init</strong> Broker should be able to read storage information from the hosted-engine config on startup and prepare itself accordingly. <code class="language-plaintext highlighter-rouge">set_storage_domain</code> call and <code class="language-plaintext highlighter-rouge">cleanup</code> calls should be removed.</li>
  <li>Cleanup storage backend code - removal of <code class="language-plaintext highlighter-rouge">BlockStorageBackend</code> class</li>
  <li>Refactoring <code class="language-plaintext highlighter-rouge">ConnectionHandler.dispatch</code> - as we don’t need client information anymore, we can split large <code class="language-plaintext highlighter-rouge">dispatch</code> functions in to a set of small functions and call them using a dict.</li>
  <li>Replace custom RPC with standard xmlrpc. <code class="language-plaintext highlighter-rouge">BrokerLink</code> classes and <code class="language-plaintext highlighter-rouge">ConnectionHandler</code> classes should be replaced with wrappers over python’s standard xmlrpc</li>
  <li>Remove broker initialization code. Broker is stateless now, so we do not need to establish and keep connection to it, neither from agent nor from the vdsm. We can throw away <code class="language-plaintext highlighter-rouge">_initialize_broker</code> function and remove it from the monitoring loop. Broker reconnection code should also be removed.</li>
</ol>

<h2 id="benefit-to-ovirt">Benefit to oVirt</h2>

<p>Less code - less errors. Standard module is well tested and it is easier to suport code based on it. We will also move some heavy stuff from agent to broker, making agent react faster.</p>




        </section>
      </section>
    </main>

    <script src="/ovirt-site/previews/2762/javascripts/lib/headings_anchors.js" type="text/javascript"></script><footer class='text-center' id='footer'><hr class='visible-print'><ul class='footer-nav-list'><li><a href='/ovirt-site/previews/2762/privacy-policy.html' target='_blank' title='Privacy policy'>Privacy policy</a></li><li><a href='/ovirt-site/previews/2762/community/about.html' target='_blank' title='About'>About</a></li><li><a href='/ovirt-site/previews/2762/general-disclaimer.html' target='_blank' title='Disclaimers'>Disclaimers</a></li></ul>&copy; 2013&ndash;2022 oVirt<div class='edit-this-page'><a href='https://github.com/oVirt/ovirt-site/issues/new?labels=content&amp;title=Issue:%20/develop/release-management/features/sla/stateless-broker.html&amp;template=' target='_blank' title='Report an issue'><i class="icon fab fa-github"></i>Report an issue with this page</a></div><div class='edit-this-page'><a href='https://github.com/oVirt/ovirt-site/edit/master/source/develop/release-management/features/sla/stateless-broker.md' target='_blank' title='Edit this page'><i class="icon fab fa-github"></i>Edit this page</a></div></footer></body>

</html>
