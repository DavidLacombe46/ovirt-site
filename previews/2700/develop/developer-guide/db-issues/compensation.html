<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <!-- Begin Jekyll SEO tag v2.7.1 -->
<title>compensation | oVirt</title>
<meta name="generator" content="Jekyll v3.9.1" />
<meta property="og:title" content="compensation" />
<meta property="og:locale" content="en" />
<meta name="description" content="oVirt is a free open-source virtualization solution for your entire enterprise" />
<meta property="og:description" content="oVirt is a free open-source virtualization solution for your entire enterprise" />
<link rel="canonical" href="https://ovirt.github.io/ovirt-site/previews/2700/develop/developer-guide/db-issues/compensation.html" />
<meta property="og:url" content="https://ovirt.github.io/ovirt-site/previews/2700/develop/developer-guide/db-issues/compensation.html" />
<meta property="og:site_name" content="oVirt" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="compensation" />
<meta name="twitter:site" content="@ovirt" />
<script type="application/ld+json">
{"publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"https://ovirt.github.io/ovirt-site/previews/2700/images/logo.svg"}},"description":"oVirt is a free open-source virtualization solution for your entire enterprise","@type":"WebPage","headline":"compensation","url":"https://ovirt.github.io/ovirt-site/previews/2700/develop/developer-guide/db-issues/compensation.html","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->

  <meta name="viewport" content="initial-scale=1.0,user-scalable=no,maximum-scale=1,width=device-width">
  <link rel="stylesheet" href="/ovirt-site/previews/2700/stylesheets/fonts.css" />
  <link rel='stylesheet' href='https://fonts.googleapis.com/css?family=Open+Sans'>
  <link rel="stylesheet" href="/ovirt-site/previews/2700/stylesheets/application.css" />
  <link rel="stylesheet" href="/ovirt-site/previews/2700/stylesheets/print.css" media="print" />
  <link rel="stylesheet" href="/ovirt-site/previews/2700/stylesheets/coderay.css" media="screen" />
  <link rel="stylesheet" href="/ovirt-site/previews/2700/stylesheets/asciidoc.css" />
  <script src="/ovirt-site/previews/2700/javascripts/vendor/jquery.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/2700/javascripts/vendor/bootstrap.min.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/2700/javascripts/vendor/bootstrap-sortable.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/2700/javascripts/vendor/moment.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/2700/javascripts/vendor/fullcalendar/fullcalendar.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/2700/javascripts/lib/cal-widget.js" type="text/javascript"></script>
  <!-- Begin Jekyll Favicon tag v0.2.9 -->
<!-- Classic -->
<link rel="shortcut icon" href="/ovirt-site/previews/2700/favicon.ico">
<link rel="icon" sizes="48x48 32x32 16x16" href="/ovirt-site/previews/2700/favicon.ico">
  <link rel="icon" sizes="16x16" type="image/png" href="/ovirt-site/previews/2700/images/favicon-16x16.png">
  <link rel="icon" sizes="32x32" type="image/png" href="/ovirt-site/previews/2700/images/favicon-32x32.png">
  <link rel="icon" sizes="64x64" type="image/png" href="/ovirt-site/previews/2700/images/favicon-64x64.png">
  <link rel="icon" sizes="144x144" type="image/png" href="/ovirt-site/previews/2700/images/favicon-144x144.png">
<!-- Safari -->
  <link rel="apple-touch-icon" sizes="57x57" href="/ovirt-site/previews/2700/images/favicon-57x57.png">
  <link rel="apple-touch-icon" sizes="76x76" href="/ovirt-site/previews/2700/images/favicon-76x76.png">
  <link rel="apple-touch-icon" sizes="120x120" href="/ovirt-site/previews/2700/images/favicon-120x120.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/ovirt-site/previews/2700/images/favicon-152x152.png">
  <link rel="apple-touch-icon" sizes="167x167" href="/ovirt-site/previews/2700/images/favicon-167x167.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/ovirt-site/previews/2700/images/favicon-180x180.png">
<!-- Chrome -->
  <link rel="icon" sizes="192x192" href="/ovirt-site/previews/2700/images/favicon-192x192.png">
  <link rel="icon" sizes="96x96" href="/ovirt-site/previews/2700/images/favicon-96x96.png">
  <link rel="icon" sizes="48x48" href="/ovirt-site/previews/2700/images/favicon-48x48.png">
<link rel="manifest" href="/ovirt-site/previews/2700/manifest.webmanifest">
<!-- IE -->
<meta name="msapplication-TileColor" content="#ffffff">
<meta name="msapplication-TileImage" content="/ovirt-site/previews/2700/images/favicon-144x144.png">
<meta name='msapplication-config' content="/ovirt-site/previews/2700/browserconfig.xml">
<!-- End Jekyll Favicon tag -->
</head>
<body class=""><header class='masthead hidden-print' id='branding' role='banner'><section class='hgroup'></section><div id='access'><nav id="mainNav" class="navbar navbar-fixed-top affix-top">  <div class="container">    <div class="col-sm-2 navbar-header">      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#menu_id0980fddf">        <span class="sr-only">Toggle navigation</span>        <span>Menu</span>        <span class="fa fa-bars"></span>      </button>      <a class="navbar-brand" href="/ovirt-site/previews/2700/">        <img id="logo" alt="oVirt" src="/ovirt-site/previews/2700/images/logo.svg">      </a>    </div>    <!-- Collect the nav links, forms, and other content for toggling -->    <div class="col-sm-10">      <div class="navbar-collapse collapse" id="menu_id0980fddf">        <ul class="nav navbar-nav">          <li class="hidden active">            <a href="#page-wrap"></a>          </li><li role='menuitem'>  <a href='/ovirt-site/previews/2700/download/'>Download</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/2700/documentation/'>Documentation</a></li><li class='active' role='menuitem'>  <a href='/ovirt-site/previews/2700/develop/'>Developers</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/2700/community/'>Community</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/2700//lists.ovirt.org/archives/'>Forum</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/2700//blogs.ovirt.org/'>Blog</a></li>              </ul>          </div>          <!-- /.navbar-collapse -->      </div>      <!-- /.container-fluid -->    </div>  </div></nav></div></header><main id="page-wrap" class="page-wrap" aria-label="Content">
      <section id="page" class="page">
        <!-- adapted from https://github.com/git-no/jekyll-breadcrumbs -->
<nav class="breadcrumbs bootstrap hidden-sm-down" aria-label="breadcrumb">

   <ol class="breadcrumb list-unstyled" vocab="http://schema.org/" typeof="BreadcrumbList">

      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/2700/">
              <span property="name"></span>
              <meta property="position" content="1" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/2700/develop/">
              <span property="name">Developers Community</span>
              <meta property="position" content="2" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/2700/develop/developer-guide/">
              <span property="name">Developer Guide</span>
              <meta property="position" content="3" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/2700/develop/developer-guide/db-issues/">
              <span property="name">Db Issues</span>
              <meta property="position" content="4" />
           </a>
        </li>
      
        
        
          

   </ol>

</nav>

        
          
            <header class="post-header col-md-4 pad-sides well well-lg">
              <h2 class="post-title entry-title">Authors:</h2>
              <header class="post-meta">
                
                  
                  
                  
                  <div class="blogger_avatar">
                    <img
                      src="https://secure.gravatar.com/avatar/d75560fd509444e4cbc70734dffa0673?s=32&amp;d=mm&amp;r=g"
                      srcset="https://secure.gravatar.com/avatar/d75560fd509444e4cbc70734dffa0673?s=64&amp;d=mm&amp;r=g 2x"
                      class="avatar avatar-32 photo"
                      height="32"
                      width="32"
                      loading="lazy">
                  </div>
                  <span class="byline">
                    <section class="entry-meta">
                      
                        <p><span class="author vcard">Eli Mesika</span></p>
                      
                    </section>
                  </span>
                
              </header>
            </header>
          
        
        <section id="content" class="content container">
          
<h1 id="compensation-mechanism">Compensation mechanism</h1>

<h2 id="what-is-compensation-all-about">What is compensation all about?</h2>

<p>*Isolation level: what changes of a transaction T are exposed to other transactions
*</p>

<p>Postgres does not implement the READ-UNCOMMITTED isolation level. We have to notify the clients ASAP on entities that are changing status, this implies committing database changes ASAP before the asynchronous tasks associated with the relevant command are complete and in order to keep transactions as short as possible, create a entity change log which we can use to revert the changes if any asynchronous task fails.
 The process of logging those changes and roll back them if something fails is called compensation.</p>

<h2 id="compensation-change-log">Compensation change log</h2>

<p>Change log is recorded in the database in the business_entity_snapshot table</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>       Column      |          Type          | Modifiers 
  -----------------+------------------------+-----------
  id              | uuid                   | not null
  command_id      | uuid                   | not null
  command_type    | character varying(256) | not null
  entity_id       | character varying(128) | 
  entity_type     | character varying(128) | 
  entity_snapshot | text                   | 
  snapshot_class  | character varying(128) | 
  snapshot_type   | integer                | 
  insertion_order | integer                |
</code></pre></div></div>

<p>Each command may affect multiple entities
A parent command may call other commands as part of its execution.</p>

<h2 id="what-changes-are-logged">What changes are logged?</h2>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>   Insertion – the ID of the new entity (compensation = delete entity by Id)
   Deletion – the deleted entity (compensation = re-insertion of the entity)
   Update – the entity before the change (compensation = update entity with “old values”)
   UpdateStatus – the status before change (compensation = update entity with “old status” - this is an optimization)
</code></pre></div></div>

<h2 id="businessentity-interface">BusinessEntity interface</h2>

<p>All compensatable entities must implement BusinessEntity interface
This interface exposes the get/set of the entity ID
The business entity must be serializable, so does the type of the ID in order to log the changes</p>

<h2 id="businessentitysnapshot">BusinessEntitySnapshot</h2>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>   CHANGED_ENTITY – update/delete
   NEW_ENTITY_ID – insert
   CHANGED_STATUS_ONLY – update status 
</code></pre></div></div>

<h2 id="compensationcontext">CompensationContext</h2>

<p>CompensationContext provides the API for adding entries to the “change log” and to flush the “change log” to DB</p>

<h2 id="when-to-compensate">When to compensate?</h2>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>   Exception in execution has occurred
   The status of the transaction is inactive (if code is run in transaction)
   Failure in execution
   Server restart with existing entries at business_entity_snapshot
</code></pre></div></div>

<h2 id="example-activatestoragedomaincommand">Example: ActivateStorageDomainCommand</h2>

<p>ChangeStorageDomainStatusInTransaction – change storage domain status to LOCKED, in a transaction + compensation code (pay attention – the code is run in a transaction scope which is comitted prior to the next step)
ActivateStorageDomainCommand VDS command is executed (this takes some time)
If VDS command successful</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>   Perform some stuff
   Change storage domain status to active (in transaction  + compensation code)
   Perform some other stuff
</code></pre></div></div>

<h2 id="usage">Usage</h2>

<p>Make sure your entity implements BusinessEntitySnapshot
Make sure its DAO implements ModificationDao and StatusAwareDao (optional, for status changes optimization)
Add at DbFacade.mapEntityToDAO an entry that maps the entity to its DAO</p>

<h2 id="using-compensation-at-a-command">Using compensation at a command</h2>

<p>Implement a CTOR that takes a commandId as parameter for Compensation after server restart
Annotate the command with @NonTransactiveCommandAttribute(forceCompensation=true) in order to eliminate creation of transaction that wraps the entire command, and in order to create a new CompensationContext
Remember to use short transactions as possible
For the last update part of the command – compensation code is not required – the transaction will rollback this part, if needed</p>




        </section>
      </section>
    </main>

    <script src="/ovirt-site/previews/2700/javascripts/lib/headings_anchors.js" type="text/javascript"></script><footer class='text-center' id='footer'><hr class='visible-print'><ul class='footer-nav-list'><li><a href='/ovirt-site/previews/2700/privacy-policy.html' target='_blank' title='Privacy policy'>Privacy policy</a></li><li><a href='/ovirt-site/previews/2700/community/about.html' target='_blank' title='About'>About</a></li><li><a href='/ovirt-site/previews/2700/general-disclaimer.html' target='_blank' title='Disclaimers'>Disclaimers</a></li></ul>&copy; 2013&ndash;2022 oVirt<div class='edit-this-page'><a href='https://github.com/oVirt/ovirt-site/issues/new?labels=content&amp;title=Issue:%20/develop/developer-guide/db-issues/compensation.html&amp;template=' target='_blank' title='Report an issue'><i class="icon fab fa-github"></i>Report an issue with this page</a></div><div class='edit-this-page'><a href='https://github.com/oVirt/ovirt-site/edit/master/source/develop/developer-guide/db-issues/compensation.md' target='_blank' title='Edit this page'><i class="icon fab fa-github"></i>Edit this page</a></div></footer></body>

</html>
