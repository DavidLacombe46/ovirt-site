<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>oVirt | oVirt is a free open-source virtualization solution for your entire enterprise</title>
<meta name="generator" content="Jekyll v3.9.2" />
<meta property="og:title" content="oVirt" />
<meta property="og:locale" content="en" />
<meta name="description" content="oVirt is a free open-source virtualization solution for your entire enterprise" />
<meta property="og:description" content="oVirt is a free open-source virtualization solution for your entire enterprise" />
<link rel="canonical" href="https://ovirt.github.io/ovirt-site/previews/2874/documentation/assembly-Setting_up_a_gpu_on_a_vm/assembly_nvidia_gpu_passthrough.html" />
<meta property="og:url" content="https://ovirt.github.io/ovirt-site/previews/2874/documentation/assembly-Setting_up_a_gpu_on_a_vm/assembly_nvidia_gpu_passthrough.html" />
<meta property="og:site_name" content="oVirt" />
<meta property="og:type" content="website" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="oVirt" />
<meta name="twitter:site" content="@ovirt" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"WebPage","description":"oVirt is a free open-source virtualization solution for your entire enterprise","headline":"oVirt","publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"https://ovirt.github.io/ovirt-site/previews/2874/images/logo.svg"}},"url":"https://ovirt.github.io/ovirt-site/previews/2874/documentation/assembly-Setting_up_a_gpu_on_a_vm/assembly_nvidia_gpu_passthrough.html"}</script>
<!-- End Jekyll SEO tag -->

  <meta name="viewport" content="initial-scale=1.0,user-scalable=no,maximum-scale=1,width=device-width">
  <link rel="stylesheet" href="/ovirt-site/previews/2874/stylesheets/fonts.css" />
  <link rel='stylesheet' href='https://fonts.googleapis.com/css?family=Open+Sans'>
  <link rel="stylesheet" href="/ovirt-site/previews/2874/stylesheets/application.css" />
  <link rel="stylesheet" href="/ovirt-site/previews/2874/stylesheets/print.css" media="print" />
  <link rel="stylesheet" href="/ovirt-site/previews/2874/stylesheets/coderay.css" media="screen" />
  <link rel="stylesheet" href="/ovirt-site/previews/2874/stylesheets/asciidoc.css" />
  <script src="/ovirt-site/previews/2874/javascripts/vendor/jquery.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/2874/javascripts/vendor/bootstrap.min.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/2874/javascripts/vendor/bootstrap-sortable.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/2874/javascripts/vendor/moment.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/2874/javascripts/vendor/fullcalendar/fullcalendar.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/2874/javascripts/lib/cal-widget.js" type="text/javascript"></script>
  <link href='/ovirt-site/previews/2874/favicon.ico' rel='shortcut icon' sizes='36x36 24x24 16x16' type='image/x-icon'/>
<link href='/ovirt-site/previews/2874/favicon.png' rel='icon' sizes='196x196' type='image/png'/>
<meta content='/ovirt-site/previews/2874/mstile-icon-128x128.png' name='msapplication-TileImage'/>
<meta content='transparent' name='msapplication-TileColor'/>
<link href='/ovirt-site/previews/2874/manifest.webmanifest' rel='manifest'/>
<meta content='/ovirt-site/previews/2874/browserconfig.xml' name='msapplication-config'/>
</head>
<body class=""><header class='masthead hidden-print' id='branding' role='banner'><section class='hgroup'></section><div id='access'><nav id="mainNav" class="navbar navbar-fixed-top affix-top">  <div class="container">    <div class="col-sm-2 navbar-header">      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#menu_id0980fddf">        <span class="sr-only">Toggle navigation</span>        <span>Menu</span>        <span class="fa fa-bars"></span>      </button>      <a class="navbar-brand" href="/ovirt-site/previews/2874/">        <img id="logo" alt="oVirt" src="/ovirt-site/previews/2874/images/logo.svg">      </a>    </div>    <!-- Collect the nav links, forms, and other content for toggling -->    <div class="col-sm-10">      <div class="navbar-collapse collapse" id="menu_id0980fddf">        <ul class="nav navbar-nav">          <li class="hidden active">            <a href="#page-wrap"></a>          </li><li role='menuitem'>  <a href='/ovirt-site/previews/2874/download/'>Download</a></li><li class='active' role='menuitem'>  <a href='/ovirt-site/previews/2874/documentation/'>Documentation</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/2874/develop/'>Developers</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/2874/community/'>Community</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/2874//lists.ovirt.org/archives/'>Forum</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/2874//blogs.ovirt.org/'>Blog</a></li>              </ul>          </div>          <!-- /.navbar-collapse -->      </div>      <!-- /.container-fluid -->    </div>  </div></nav></div></header><main id="page-wrap" class="page-wrap" aria-label="Content">
      <section id="page" class="page">
        <!-- adapted from https://github.com/git-no/jekyll-breadcrumbs -->
<nav class="breadcrumbs bootstrap hidden-sm-down" aria-label="breadcrumb">

   <ol class="breadcrumb list-unstyled" vocab="http://schema.org/" typeof="BreadcrumbList">

      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/2874/">
              <span property="name"></span>
              <meta property="position" content="1" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/2874/documentation/">
              <span property="name">Documentation</span>
              <meta property="position" content="2" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/2874/documentation/assembly-Setting_up_a_gpu_on_a_vm/">
              <span property="name">Assembly Setting Up A Gpu On A Vm</span>
              <meta property="position" content="3" />
           </a>
        </li>
      
        
        
          

   </ol>

</nav>

        
          
        
        <section id="content" class="content container">
          
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>Red Hat Virtualization supports PCI VFIO, also called device passthrough, for some NVIDIA PCIe-based GPU devices as non-VGA graphics devices.</p>
</div>
<div class="paragraph">
<p>You can attach one or more host GPUs to a single virtual machine by passing through the host GPU to the virtual machine, in addition to one of the standard emulated graphics interfaces. The virtual machine uses the emulated graphics device for pre-boot and installation, and the GPU takes control when its graphics drivers are loaded.</p>
</div>
<div class="paragraph">
<p>For information on the exact number of host GPUs that you can pass through to a single virtual machine, see the NVIDIA website.</p>
</div>
<div class="paragraph">
<p>To assign a GPU to a virtual machine, follow the steps in these procedures:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="#Enabling_IOMMU_support_in_the_host_machine_kernel">Enable the I/O Memory Management Unit (IOMMU) on the host machine.</a></p>
</li>
<li>
<p><a href="#Detaching_the_GPU_device_from_the_host">Detach the GPU from the host.</a></p>
</li>
<li>
<p><a href="#Attaching_the_GPU_to_a_Virtual_Machine">Attach the GPU to the guest.</a></p>
</li>
<li>
<p><a href="#proc_install-nvidia-vgpu-guest-driver_nvidia_gpu_passthrough">Install GPU drivers on the guest.</a></p>
</li>
<li>
<p><a href="#Updating_and_Enabling_xorg">Configure Xorg on the guest.</a></p>
</li>
</ol>
</div>
<div class="paragraph">
<p>These steps are detailed below.</p>
</div>
<div id="prerequisites" class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>Your GPU device supports GPU passthrough mode.</p>
</li>
<li>
<p>Your system is listed as a validated server hardware platform.</p>
</li>
<li>
<p>Your host chipset supports Intel VT-d or AMD-Vi</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>For more information about supported hardware and software, see <a href="https://docs.nvidia.com/grid/latest/grid-vgpu-release-notes-red-hat-el-kvm/index.html#validated-platforms">Validated Platforms</a> in the <em>NVIDIA GPU Software Release Notes</em>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="Enabling_IOMMU_support_in_the_host_machine_kernel">Enabling host IOMMU support and blacklisting nouveau</h2>
<div class="sectionbody">
<div class="paragraph">
<p>I/O Memory Management Unit (IOMMU) support on the host machine is necessary to use a GPU on a virtual machine.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>In the Administration Portal, click <span class="menuseq"><b class="menu">Compute</b>&#160;<i class="fa fa-angle-right caret"></i> <b class="menuitem">Hosts</b></span>. Select a host and click <b class="button">Edit</b>. The <strong>Edit Hosts</strong> pane appears.</p>
</li>
<li>
<p>Click the <strong>Kernel</strong> tab.</p>
</li>
<li>
<p>Check the <strong>Hostdev Passthrough &amp; SR-IOV</strong> checkbox. This checkbox enables IOMMU support for a host with Intel VT-d or AMD Vi by adding <code>intel_iommu=on</code> or <code>amd_iommu=on</code> to the kernel command line.</p>
</li>
<li>
<p>Check the <strong>Blacklist Nouveau</strong> checkbox.</p>
</li>
<li>
<p>Click <b class="button">OK</b>.</p>
</li>
<li>
<p>Select the host and click <span class="menuseq"><b class="menu">Management</b>&#160;<i class="fa fa-angle-right caret"></i> <b class="menuitem">Maintenance</b></span> and <b class="button">OK</b>.</p>
</li>
<li>
<p>Click <span class="menuseq"><b class="menu">Installation</b>&#160;<i class="fa fa-angle-right caret"></i> <b class="menuitem">Reinstall</b></span>.</p>
</li>
<li>
<p>After the reinstallation is finished, reboot the host machine.</p>
</li>
<li>
<p>When the host machine has rebooted, click <span class="menuseq"><b class="menu">Management</b>&#160;<i class="fa fa-angle-right caret"></i> <b class="menuitem">Activate</b></span>.</p>
</li>
</ol>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>To enable IOMMU support using the command line, edit the <code>grub.conf</code> file in the virtual machine (./entries/rhvh-4.4.&lt;machine id&gt;.conf) to include the option <code>intel_iommu=on</code>.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="Detaching_the_GPU_device_from_the_host">Detaching the GPU from the host</h2>
<div class="sectionbody">
<div class="paragraph">
<p>You cannot add the GPU to the virtual machine if the GPU is bound to the host kernel driver, so you must unbind the GPU device from the host before you can add it to the virtual machine. Host drivers often do not support dynamic unbinding of the GPU, so it is recommended to manually exclude the device from binding to the host drivers.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>On the host, identify the device slot name and IDs of the device by running the <code class="command">lspci</code> command. In the following example, a graphics controller such as an NVIDIA Quadro or GRID card is used:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># lspci -Dnn | grep -i NVIDIA
0000:03:00.0 VGA compatible controller [0300]: NVIDIA Corporation GK104GL [Quadro K4200] [10de:11b4] (rev a1)
0000:03:00.1 Audio device [0403]: NVIDIA Corporation GK104 HDMI Audio Controller [10de:0e0a] (rev a1)</pre>
</div>
</div>
<div class="paragraph">
<p>The output shows that the NVIDIA GK104 device is installed. It has a graphics controller and an audio controller with the following properties:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The device slot name of the graphics controller is <code>0000:03:00.0</code>, and the vendor-id:device-id for the graphics controller are <code>10de:11b4</code>.</p>
</li>
<li>
<p>The device slot name of the audio controller is <code>0000:03:00.1</code>, and the vendor-id:device-id for the audio controller are <code>10de:0e0a</code>.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Prevent the host machine driver from using the GPU device. You can use a vendor-id:device-id with the pci-stub driver. To do this, append the <code>pci-stub.ids</code> option, with the vendor-id:device-id as its value, to the <code>GRUB_CMDLINX_LINUX</code> environment variable located in the <code>/etc/sysconfig/grub</code> configuration file, for example:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">GRUB_CMDLINE_LINUX="crashkernel=auto resume=/dev/mapper/vg0-lv_swap rd.lvm.lv=vg0/lv_root rd.lvm.lv=vg0/lv_swap rhgb quiet intel_iommu=on pci-stub.ids=10de:11b4,10de:0e0a"</pre>
</div>
</div>
<div class="paragraph">
<p>When adding additional vendor IDs and device IDs for pci-stub, separate them with a comma.</p>
</div>
</li>
<li>
<p>Regenerate the boot loader configuration using grub2-mkconfig to include this option:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># grub2-mkconfig -o /etc/grub2.cfg</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>When using a UEFI-based host, the target file should be <code class="filename">/etc/grub2-efi.cfg</code>.</p>
</div>
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Reboot the host machine.</p>
</li>
<li>
<p>Confirm that IOMMU is enabled, the host device is added to the list of pci-stub.ids, and Nouveau is blacklisted:</p>
<div class="literalblock">
<div class="content">
<pre class="nowrap"># cat /proc/cmdline
BOOT_IMAGE=(hd0,msdos1)/vmlinuz-4.18.0-147.el8.x86_64 root=/dev/mapper/vg0-lv_root ro crashkernel=auto resume=/dev/mapper/vg0-lv_swap rd.lvm.lv=vg0/lv_root rd.lvm.lv=vg0/lv_swap rhgb quiet <strong>intel_iommu=on</strong> <i class="conum" data-value="1"></i><b>(1)</b>
<strong>pci-stub.ids=10de:11b4,10de:0e0a</strong> <i class="conum" data-value="2"></i><b>(2)</b>
<strong>rdblacklist=nouveau</strong> <i class="conum" data-value="3"></i><b>(3)</b></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>IOMMU is enabled</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>the host device is added to the list of pci-stub.ids</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Nouveau is blacklisted</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="Attaching_the_GPU_to_a_Virtual_Machine">Attaching the GPU to a Virtual Machine</h2>
<div class="sectionbody">
<div class="paragraph">
<p>After unbinding the GPU from host kernel driver, you can add it to the virtual machine and enable the correct driver.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Follow the steps in <a href="{URL_virt_product_docs}{URL_format}virtual_machine_management_guide/index#Adding_Host_Devices_to_a_Virtual_Machine">Adding a Host Device to a Virtual Machine</a> in the <em>Virtual Machine Management Guide</em>.</p>
</li>
<li>
<p>Run the virtual machine and log in to it.</p>
</li>
<li>
<p>Install the NVIDIA GPU driver on the virtual machine.</p>
</li>
<li>
<p>Verify that the correct kernel driver is in use for the GPU with the <code class="command">lspci -nnk</code> command. For example:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># lspci -nnk
00:07.0 VGA compatible controller [0300]: NVIDIA Corporation GK104GL [Quadro K4200] [10de:11b4] (rev a1)
Subsystem: Hewlett-Packard Company Device [103c:1096]
Kernel driver in use: nvidia
Kernel modules: nouveau, nvidia_drm, nvidia</pre>
</div>
</div>
</li>
</ol>
</div>
</div>
</div>
<div class="sect1">
<h2 id="proc_install-nvidia-vgpu-guest-driver_nvidia_gpu_passthrough">Installing the GPU driver on the virtual machine</h2>
<div class="sectionbody">
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Run the virtual machine and connect to it using the VNC or SPICE console.</p>
</li>
<li>
<p>Download the driver to the virtual machine. For information on getting the driver, see <a href="https://www.nvidia.com/Download/index.aspx?lang=en-us">the Drivers page on the NVIDIA website</a>.</p>
</li>
<li>
<p>Install the GPU driver.</p>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p><strong>Linux only:</strong> When installing the driver on a Linux guest operating system, you are prompted to update xorg.conf. If you do not update xorg.conf during the installation, you need to update it manually.</p>
</div>
</td>
</tr>
</table>
</div>
</li>
<li>
<p>After the driver finishes installing, reboot the machine. <strong>For Windows virtual machines,</strong> fully power off the guest from the Administration portal or the VM portal, not from within the guest operating system.</p>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p><strong>Windows only:</strong> Powering off the virtual machine from within the Windows guest operating system sometimes sends the virtual machine into hibernate mode, which does not completely clear the memory, possibly leading to subsequent problems. Using the Administration portal or the VM portal to power off the virtual machine forces it to fully clean the memory.</p>
</div>
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Connect a monitor to the host GPU output interface and run the virtual machine.</p>
</li>
<li>
<p>Set up NVIDIA vGPU guest software licensing for each vGPU and add the license credentials in the NVIDIA control panel. For more information, see  <a href="https://docs.nvidia.com/grid/latest/grid-licensing-user-guide/index.html#how-grid-licensing-works">How NVIDIA vGPU Software Licensing Is Enforced</a> in the <em>NVIDIA Virtual GPU Software Documentation</em>.</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect1">
<h2 id="Updating_and_Enabling_xorg">Updating and Enabling xorg (Linux Virtual Machines)</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Before you can use the GPU on the virtual machine, you need to update and enable xorg on the virtual machine. The NVIDIA driver installation should do this automatically. Check if xorg is updated and enabled by viewing <code class="filename">/etc/X11/xorg.conf</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># cat /etc/X11/xorg.conf</pre>
</div>
</div>
<div class="paragraph">
<p>The first two lines say if it was generated by NVIDIA. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># cat /etc/X11/xorg.conf
# nvidia-xconfig: X configuration file generated by nvidia-xconfig
# nvidia-xconfig: version 390.87 (buildmeister@swio-display-x64-rhel04-14) Tue Aug 21 17:33:38 PDT 2018</pre>
</div>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>On the virtual machine, generate the <code>xorg.conf</code> file using following command:</p>
<div class="listingblock">
<div class="content">
<pre># X -configure</pre>
</div>
</div>
</li>
<li>
<p>Copy the <code>xorg.conf</code> file to <code>/etc/X11/xorg.conf</code> using the following command:</p>
<div class="listingblock">
<div class="content">
<pre># cp /root/xorg.conf.new /etc/X11/xorg.conf</pre>
</div>
</div>
</li>
<li>
<p>Reboot the virtual machine.</p>
</li>
<li>
<p>Verify that xorg is updated and enabled by viewing <code class="filename">/etc/X11/xorg.conf</code>:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># cat /etc/X11/xorg.conf</pre>
</div>
</div>
<div class="paragraph">
<p>Search for the <strong><code>Device</code></strong> section. You should see an entry similar to the following section:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">Section "Device"
    Identifier     "Device0"
    Driver         "nvidia"
    VendorName     "NVIDIA Corporation"
EndSection</pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>The GPU is now assigned to the virtual machine.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="related-information">Removing a host GPU from a virtual machine</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>For information on removing a host GPU from a virtual machine, see <a href="{URL_virt_product_docs}{URL_format}virtual_machine_management_guide/index#Removing_Host_Devices_from_a_Virtual_Machine">Removing Host Devices from a Virtual Machine</a> in the <em>Virtual Machine Management Guide</em>.</p>
</li>
</ul>
</div>
</div>
</div>



        </section>
      </section>
    </main>

    <script src="/ovirt-site/previews/2874/javascripts/lib/headings_anchors.js" type="text/javascript"></script><footer class='text-center' id='footer'><hr class='visible-print'><ul class='footer-nav-list'><li><a href='/ovirt-site/previews/2874/privacy-policy.html' target='_blank' title='Privacy policy'>Privacy policy</a></li><li><a href='/ovirt-site/previews/2874/community/about.html' target='_blank' title='About'>About</a></li><li><a href='/ovirt-site/previews/2874/general-disclaimer.html' target='_blank' title='Disclaimers'>Disclaimers</a></li></ul>&copy; 2013&ndash;2022 oVirt<div class='edit-this-page'><a href='https://github.com/oVirt/ovirt-site/issues/new?labels=documentation&amp;title=Issue:%20/documentation/assembly-Setting_up_a_gpu_on_a_vm/assembly_nvidia_gpu_passthrough.html&amp;template=issue_template_documentation.md' target='_blank' title='Report an issue'><i class="icon fab fa-github"></i>Report an issue with this page</a></div><div class='edit-this-page'><a href='https://github.com/oVirt/ovirt-site/edit/master/source/documentation/assembly-Setting_up_a_gpu_on_a_vm/assembly_nvidia_gpu_passthrough.adoc' target='_blank' title='Edit this page'><i class="icon fab fa-github"></i>Edit this page</a></div></footer></body>

</html>
