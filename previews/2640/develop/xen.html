<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <!-- Begin Jekyll SEO tag v2.7.1 -->
<title>Xen | oVirt</title>
<meta name="generator" content="Jekyll v3.9.1" />
<meta property="og:title" content="Xen" />
<meta name="author" content="Dan Kenigsberg" />
<meta property="og:locale" content="en" />
<meta name="description" content="oVirt is a free open-source virtualization solution for your entire enterprise" />
<meta property="og:description" content="oVirt is a free open-source virtualization solution for your entire enterprise" />
<link rel="canonical" href="https://ovirt.github.io/ovirt-site/previews/2640/develop/xen.html" />
<meta property="og:url" content="https://ovirt.github.io/ovirt-site/previews/2640/develop/xen.html" />
<meta property="og:site_name" content="oVirt" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Xen" />
<meta name="twitter:site" content="@ovirt" />
<meta name="twitter:creator" content="@Dan Kenigsberg" />
<script type="application/ld+json">
{"author":{"@type":"Person","name":"Dan Kenigsberg"},"publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"https://ovirt.github.io/ovirt-site/previews/2640/images/logo.svg"},"name":"Dan Kenigsberg"},"description":"oVirt is a free open-source virtualization solution for your entire enterprise","@type":"WebPage","headline":"Xen","url":"https://ovirt.github.io/ovirt-site/previews/2640/develop/xen.html","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->

  <meta name="viewport" content="initial-scale=1.0,user-scalable=no,maximum-scale=1,width=device-width">
  <link rel="stylesheet" href="/ovirt-site/previews/2640/stylesheets/fonts.css" />
  <link rel='stylesheet' href='https://fonts.googleapis.com/css?family=Open+Sans'>
  <link rel="stylesheet" href="/ovirt-site/previews/2640/stylesheets/application.css" />
  <link rel="stylesheet" href="/ovirt-site/previews/2640/stylesheets/print.css" media="print" />
  <link rel="stylesheet" href="/ovirt-site/previews/2640/stylesheets/coderay.css" media="screen" />
  <link rel="stylesheet" href="/ovirt-site/previews/2640/stylesheets/asciidoc.css" />
  <script src="/ovirt-site/previews/2640/javascripts/vendor/jquery.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/2640/javascripts/vendor/bootstrap.min.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/2640/javascripts/vendor/bootstrap-sortable.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/2640/javascripts/vendor/moment.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/2640/javascripts/vendor/fullcalendar/fullcalendar.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/2640/javascripts/lib/cal-widget.js" type="text/javascript"></script>
  <!-- Begin Jekyll Favicon tag v0.2.9 -->
<!-- Classic -->
<link rel="shortcut icon" href="/ovirt-site/previews/2640/favicon.ico">
<link rel="icon" sizes="48x48 32x32 16x16" href="/ovirt-site/previews/2640/favicon.ico">
  <link rel="icon" sizes="16x16" type="image/png" href="/ovirt-site/previews/2640/images/favicon-16x16.png">
  <link rel="icon" sizes="32x32" type="image/png" href="/ovirt-site/previews/2640/images/favicon-32x32.png">
  <link rel="icon" sizes="64x64" type="image/png" href="/ovirt-site/previews/2640/images/favicon-64x64.png">
  <link rel="icon" sizes="144x144" type="image/png" href="/ovirt-site/previews/2640/images/favicon-144x144.png">
<!-- Safari -->
  <link rel="apple-touch-icon" sizes="57x57" href="/ovirt-site/previews/2640/images/favicon-57x57.png">
  <link rel="apple-touch-icon" sizes="76x76" href="/ovirt-site/previews/2640/images/favicon-76x76.png">
  <link rel="apple-touch-icon" sizes="120x120" href="/ovirt-site/previews/2640/images/favicon-120x120.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/ovirt-site/previews/2640/images/favicon-152x152.png">
  <link rel="apple-touch-icon" sizes="167x167" href="/ovirt-site/previews/2640/images/favicon-167x167.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/ovirt-site/previews/2640/images/favicon-180x180.png">
<!-- Chrome -->
  <link rel="icon" sizes="192x192" href="/ovirt-site/previews/2640/images/favicon-192x192.png">
  <link rel="icon" sizes="96x96" href="/ovirt-site/previews/2640/images/favicon-96x96.png">
  <link rel="icon" sizes="48x48" href="/ovirt-site/previews/2640/images/favicon-48x48.png">
<link rel="manifest" href="/ovirt-site/previews/2640/manifest.webmanifest">
<!-- IE -->
<meta name="msapplication-TileColor" content="#ffffff">
<meta name="msapplication-TileImage" content="/ovirt-site/previews/2640/images/favicon-144x144.png">
<meta name='msapplication-config' content="/ovirt-site/previews/2640/browserconfig.xml">
<!-- End Jekyll Favicon tag -->
</head>
<body class=""><header class='masthead hidden-print' id='branding' role='banner'><section class='hgroup'></section><div id='access'><nav id="mainNav" class="navbar navbar-fixed-top affix-top">  <div class="container">    <div class="col-sm-2 navbar-header">      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#menu_id0980fddf">        <span class="sr-only">Toggle navigation</span>        <span>Menu</span>        <span class="fa fa-bars"></span>      </button>      <a class="navbar-brand" href="/ovirt-site/previews/2640/">        <img id="logo" alt="oVirt" src="/ovirt-site/previews/2640/images/logo.svg">      </a>    </div>    <!-- Collect the nav links, forms, and other content for toggling -->    <div class="col-sm-10">      <div class="navbar-collapse collapse" id="menu_id0980fddf">        <ul class="nav navbar-nav">          <li class="hidden active">            <a href="#page-wrap"></a>          </li><li role='menuitem'>  <a href='/ovirt-site/previews/2640/download/'>Download</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/2640/documentation/'>Documentation</a></li><li class='active' role='menuitem'>  <a href='/ovirt-site/previews/2640/develop/'>Developers</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/2640/community/'>Community</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/2640//lists.ovirt.org/archives/'>Forum</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/2640//blogs.ovirt.org/'>Blog</a></li>              </ul>          </div>          <!-- /.navbar-collapse -->      </div>      <!-- /.container-fluid -->    </div>  </div></nav></div></header><main id="page-wrap" class="page-wrap" aria-label="Content">
      <section id="page" class="page">
        <!-- adapted from https://github.com/git-no/jekyll-breadcrumbs -->
<nav class="breadcrumbs bootstrap hidden-sm-down" aria-label="breadcrumb">

   <ol class="breadcrumb list-unstyled" vocab="http://schema.org/" typeof="BreadcrumbList">

      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/2640/">
              <span property="name"></span>
              <meta property="position" content="1" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/2640/develop/">
              <span property="name">Developers Community</span>
              <meta property="position" content="2" />
           </a>
        </li>
      
        
        
          

   </ol>

</nav>

        
          
            <header class="post-header col-md-4 pad-sides well well-lg">
              <h2 class="post-title entry-title">Authors:</h2>
              <header class="post-meta">
                
                  
                  
                  
                  <div class="blogger_avatar">
                    <img
                      src="https://secure.gravatar.com/avatar/ce421080e5d2da87febb626f6e8906c9?s=32&amp;d=mm&amp;r=g"
                      srcset="https://secure.gravatar.com/avatar/ce421080e5d2da87febb626f6e8906c9?s=64&amp;d=mm&amp;r=g 2x"
                      class="avatar avatar-32 photo"
                      height="32"
                      width="32"
                      loading="lazy">
                  </div>
                  <span class="byline">
                    <section class="entry-meta">
                      
                        <p><span class="author vcard">Dan Kenigsberg</span></p>
                      
                    </section>
                  </span>
                
                  
                  
                  
                  <div class="blogger_avatar">
                    <img
                      src="https://secure.gravatar.com/avatar/65fafd7adcef0c369b149759491fae7f?s=32&amp;d=mm&amp;r=g"
                      srcset="https://secure.gravatar.com/avatar/65fafd7adcef0c369b149759491fae7f?s=64&amp;d=mm&amp;r=g 2x"
                      class="avatar avatar-32 photo"
                      height="32"
                      width="32"
                      loading="lazy">
                  </div>
                  <span class="byline">
                    <section class="entry-meta">
                      
                        <p><span class="author vcard"></span><a rel="author" href="https://twitter.com/sandrobonazzola" title="Sandro Bonazzola">Sandro Bonazzola</a></span></p>
                      
                    </section>
                  </span>
                
              </header>
            </header>
          
        
        <section id="content" class="content container">
          
<!-- TODO: Content review -->

<h1 id="configuring-xen-hosts">Configuring Xen Hosts</h1>

<p>oVirt uses libvirt to abstract access to its virtual machines. This makes it theoretically possible for oVirt to manage Xen hosts. Trying this out was a goal in <a href="http://wiki.xen.org/wiki/Hackathon/May2014#Libvirt_and_Xen_integration_.2F_co-operation">Xen hackathon 2014</a>.</p>

<p>This is not going to be easy, as oVirt is permeated with KVM-specific assumptions, and Xen (or libvirt’s xenlight driver) is currently missing features that are important to oVirt. Still, we’ve managed to add a Xen dom0 to oVirt and start a VM with Fedora guest.</p>

<p>This page describes the hacked solution, and tracks the known gaps to its fruition.</p>

<h2 id="whats-done-and-how-to-use-it">What’s Done and How to Use It</h2>

<ol>
  <li>To manage Xen hosts in oVirt, you first need a Xen host to manage. I followed <a href="http://wiki.xen.org/wiki/Fedora_Host_Installation">http://wiki.xen.org/wiki/Fedora_Host_Installation</a> to install Xen on Fedora 19. Please note that you’d better set up a bridge named <code class="language-plaintext highlighter-rouge">ovirtmgmt</code> instead of <code class="language-plaintext highlighter-rouge">br0</code>. Reboot the host to see that everything is fine, and that you have access to your dom0.</li>
  <li>A second step is to installed an unchanged oVirt Engine on a host. I used an <a href="/ovirt-site/previews/2640/develop/release-management/features/integration/allinone.html">All-in-One</a> installation of oVirt, running on my Xen dom0.</li>
  <li>I needed to modify Vdsm in so it would be possible to run Xen VMs. My patches are not expected to by accepted upstream, at least not in their current form, so you would need to build Vdsm <a href="/ovirt-site/previews/2640/develop/developer-guide/vdsm/developers.html">from source</a>, first applying the <a href="http://gerrit.ovirt.org/#/q/status:open+project:vdsm+branch:master+topic:xen,n,z">Xen-related patches</a>. When you build Vdsm, take note of <a href="/ovirt-site/previews/2640/develop/developer-guide/vdsm/developers.html#building-with-hooks-support">Vdsm_Developers#Building_with_hooks_support</a>.</li>
  <li>Install Vdsm on your dom0. Do not forget to install vdsm-hook-xen.rpm, too.</li>
  <li>
    <p>On your Engine host,</p>

    <ol>
      <li>cat «EOF &gt;/etc/ovirt-host-deploy.conf.d/50-xen.conf
```
[environment:enforce]</li>
    </ol>

    <p>VDSM/checkVirtHardware=bool:False</p>

    <p>EOF
```</p>
  </li>
  <li>Log into your Engine’s admin portal, and add your dom0 to your cluster. Define a VM and start it up.</li>
  <li>To actually have something running inside the VM, I’ve copied a Fedora image onto the VM’s disk volume. I suppose that importing a VM would work, too.</li>
</ol>

<h2 id="whats-not-done">What’s not Done</h2>

<p>The whole thing is a fragile hack, with plenty of stuff yet to be solved. The TO-DO list is split to Vdsm-side fixes, and libvirt-side fixes.</p>

<h3 id="ovirt-host-deploy">ovirt-host-deploy</h3>

<ol>
  <li>Identify that the added host is a Xen dom0, and check Virt Hardware appropriately.</li>
</ol>

<h3 id="vdsm">Vdsm</h3>

<ol>
  <li>virt/vm.py has strict assumptions on how each device is reported in libvirt’s domain xml. However, Xen’s devices do not have a bus address, or a driver, or even an alias. Vdsm should learn to identify devices without this information, or get libvirt-xl expose it.</li>
  <li>Xen does not support virtio-serial. Guests agents could be tweaked to use Xen paravirt consoles instead. Until then - virtio-serial devices should not be passed to libvirt</li>
  <li>Xen’s balloon is not implemented as a virtio-device. Vdsm should user the proper means to specify balloon existence and its size changes.</li>
  <li>virtio-net and virtio-block are not supported. The hook converts them to Xen paravirt devices.</li>
  <li>I did not try spice, as I was told that it’s broken on lower levels, but that’s supposedly not exact.</li>
</ol>

<h3 id="libvirt-xl-driver">libvirt xl driver</h3>

<ol>
  <li>I found no way to specify “qcow2” in libxl images. Only raw images can be used.</li>
  <li>Implement virConnectCompareCPU. At the moment, Vdsm connects to <code class="language-plaintext highlighter-rouge">qemu:///system</code> to use this API call.</li>
  <li>Expose an alias per virtual device. Aliases are assigned by libvirt and are used to uniquely identify a device.</li>
  <li>When a cdrom is specified with</li>
</ol>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="nt">&lt;tt&gt;&lt;disk</span> <span class="na">device=</span><span class="s">"cdrom"</span> <span class="na">snapshot=</span><span class="s">"no"</span> <span class="na">type=</span><span class="s">"file"</span><span class="nt">&gt;</span>

    <span class="nt">&lt;target</span> <span class="na">bus=</span><span class="s">"ide"</span> <span class="na">dev=</span><span class="s">"hdc"</span><span class="nt">/&gt;</span>

    <span class="nt">&lt;readonly/&gt;</span>

    <span class="nt">&lt;serial/&gt;</span>

    <span class="nt">&lt;/disk&gt;&lt;/tt&gt;</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>the VM does not attempt to boot from its hard disk. Only complete removal of cdrom worked for me.
</code></pre></div></div>

<ol>
  <li>When the above cdrom spec has file=””, libvirt does a frightening null-pointer dereferencing, instead of interpreting this as an empty cdrom</li>
  <li>On an occasion which I did not reproduce, <code class="language-plaintext highlighter-rouge">virsh dumpxml dom</code> reported a wrong vnc port. This made <code class="language-plaintext highlighter-rouge">virt-viewer</code> fail, while <code class="language-plaintext highlighter-rouge">xl vncviewer</code> worked fine.</li>
  <li>Some consider this a Xen feature, but for me it is a bug: if for some reason qemu dies, the Xen domain may still live on, and libvirt does not report of any issue. That’s usually bad of HVM guests - qemu was started for a reason (to emulate devices) and without it, the guest is not going to get very far along. I’d rather have a means to specify that I’d like such a VM to be shut down in this condition, or at least be told that it has lost its device emulation.</li>
  <li>When VM fails to boot, <code class="language-plaintext highlighter-rouge">&lt;on_crash&gt;destroy&lt;/on_crash&gt;</code> takes into actions and stops the VM. My attempts to change this to <code class="language-plaintext highlighter-rouge">preserve</code> proved futile.</li>
  <li>No support for floppy, which is still (seldom) used by oVirt</li>
  <li><code class="language-plaintext highlighter-rouge">&lt;interface&gt;&lt;filterref&gt;</code> is silently ignored</li>
  <li>There is no <code class="language-plaintext highlighter-rouge">&lt;link state="down"&gt;</code>.</li>
  <li>VNC password cannot be set <code class="language-plaintext highlighter-rouge">libvirtError: unsupported configuration: device type 'graphics' cannot be updated</code></li>
  <li>I failed to connect to the VNC port from outside dom0; I have no idea why I get <code class="language-plaintext highlighter-rouge">unable connect to socket: Connection refused (111)</code> with iptables set to ACCEPT all.</li>
  <li>Live migration is in the works</li>
  <li>Migration cancellation is missing</li>
  <li>VIR_DOMAIN_DESTROY_GRACEFUL is unsupported: Unknown libvirterror: ecode: 8 edom: 41 level: 2 message: unsupported flags (0x1) in function libxlDomainDestroyFlags</li>
</ol>

<h3 id="xen">Xen</h3>

<ol>
  <li>When asked to start a domain with only 64MiB RAM, things break in an odd way. qemu dies, but libvirt reports the domain as running.</li>
  <li>No CPU hot-plugging, and certainly not something compatible with oVirt’s implementation (of starting a VM with 160 considerable CPUs, and setting the current number to 1).</li>
</ol>

<h3 id="nested-kvm">Nested KVM</h3>

<p>If I could run HVM Xen guests within KVM L1 guests, development would have been easier. Unfortunately, with kernel-3.14.5-200.fc20.x86_64 and qemu-kvm-2.0.0-5.fc20.x86_64 on the host, the L1 dom0 `xl dmesg` complains about</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  (XEN) VMX: CPU0 has insufficient VMExit Control (000f6fff; requires 00008200)
  (XEN) VMX: failed to initialise.
</code></pre></div></div>





        </section>
      </section>
    </main>

    <script src="/ovirt-site/previews/2640/javascripts/lib/headings_anchors.js" type="text/javascript"></script><footer class='text-center' id='footer'><hr class='visible-print'><ul class='footer-nav-list'><li><a href='/ovirt-site/previews/2640/privacy-policy.html' target='_blank' title='Privacy policy'>Privacy policy</a></li><li><a href='/ovirt-site/previews/2640/community/about.html' target='_blank' title='About'>About</a></li><li><a href='/ovirt-site/previews/2640/general-disclaimer.html' target='_blank' title='Disclaimers'>Disclaimers</a></li></ul>&copy; 2013&ndash;2021 oVirt<div class='edit-this-page'><a href='https://github.com/oVirt/ovirt-site/issues/new?labels=content&amp;title=Issue:%20/develop/xen.html&amp;template=' target='_blank' title='Report an issue'><i class="icon fab fa-github"></i>Report an issue with this page</a></div><div class='edit-this-page'><a href='https://github.com/oVirt/ovirt-site/edit/master/source/develop/xen.md' target='_blank' title='Edit this page'><i class="icon fab fa-github"></i>Edit this page</a></div></footer></body>

</html>
