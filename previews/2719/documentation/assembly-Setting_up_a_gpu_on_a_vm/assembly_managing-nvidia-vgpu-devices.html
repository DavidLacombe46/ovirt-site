<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <!-- Begin Jekyll SEO tag v2.7.1 -->
<title>oVirt | oVirt is a free open-source virtualization solution for your entire enterprise</title>
<meta name="generator" content="Jekyll v3.9.1" />
<meta property="og:title" content="oVirt" />
<meta property="og:locale" content="en" />
<meta name="description" content="oVirt is a free open-source virtualization solution for your entire enterprise" />
<meta property="og:description" content="oVirt is a free open-source virtualization solution for your entire enterprise" />
<link rel="canonical" href="https://ovirt.github.io/ovirt-site/previews/2719/documentation/assembly-Setting_up_a_gpu_on_a_vm/assembly_managing-nvidia-vgpu-devices.html" />
<meta property="og:url" content="https://ovirt.github.io/ovirt-site/previews/2719/documentation/assembly-Setting_up_a_gpu_on_a_vm/assembly_managing-nvidia-vgpu-devices.html" />
<meta property="og:site_name" content="oVirt" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="oVirt" />
<meta name="twitter:site" content="@ovirt" />
<script type="application/ld+json">
{"publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"https://ovirt.github.io/ovirt-site/previews/2719/images/logo.svg"}},"description":"oVirt is a free open-source virtualization solution for your entire enterprise","@type":"WebPage","headline":"oVirt","url":"https://ovirt.github.io/ovirt-site/previews/2719/documentation/assembly-Setting_up_a_gpu_on_a_vm/assembly_managing-nvidia-vgpu-devices.html","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->

  <meta name="viewport" content="initial-scale=1.0,user-scalable=no,maximum-scale=1,width=device-width">
  <link rel="stylesheet" href="/ovirt-site/previews/2719/stylesheets/fonts.css" />
  <link rel='stylesheet' href='https://fonts.googleapis.com/css?family=Open+Sans'>
  <link rel="stylesheet" href="/ovirt-site/previews/2719/stylesheets/application.css" />
  <link rel="stylesheet" href="/ovirt-site/previews/2719/stylesheets/print.css" media="print" />
  <link rel="stylesheet" href="/ovirt-site/previews/2719/stylesheets/coderay.css" media="screen" />
  <link rel="stylesheet" href="/ovirt-site/previews/2719/stylesheets/asciidoc.css" />
  <script src="/ovirt-site/previews/2719/javascripts/vendor/jquery.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/2719/javascripts/vendor/bootstrap.min.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/2719/javascripts/vendor/bootstrap-sortable.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/2719/javascripts/vendor/moment.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/2719/javascripts/vendor/fullcalendar/fullcalendar.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/2719/javascripts/lib/cal-widget.js" type="text/javascript"></script>
  <!-- Begin Jekyll Favicon tag v0.2.9 -->
<!-- Classic -->
<link rel="shortcut icon" href="/ovirt-site/previews/2719/favicon.ico">
<link rel="icon" sizes="48x48 32x32 16x16" href="/ovirt-site/previews/2719/favicon.ico">
  <link rel="icon" sizes="16x16" type="image/png" href="/ovirt-site/previews/2719/images/favicon-16x16.png">
  <link rel="icon" sizes="32x32" type="image/png" href="/ovirt-site/previews/2719/images/favicon-32x32.png">
  <link rel="icon" sizes="64x64" type="image/png" href="/ovirt-site/previews/2719/images/favicon-64x64.png">
  <link rel="icon" sizes="144x144" type="image/png" href="/ovirt-site/previews/2719/images/favicon-144x144.png">
<!-- Safari -->
  <link rel="apple-touch-icon" sizes="57x57" href="/ovirt-site/previews/2719/images/favicon-57x57.png">
  <link rel="apple-touch-icon" sizes="76x76" href="/ovirt-site/previews/2719/images/favicon-76x76.png">
  <link rel="apple-touch-icon" sizes="120x120" href="/ovirt-site/previews/2719/images/favicon-120x120.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/ovirt-site/previews/2719/images/favicon-152x152.png">
  <link rel="apple-touch-icon" sizes="167x167" href="/ovirt-site/previews/2719/images/favicon-167x167.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/ovirt-site/previews/2719/images/favicon-180x180.png">
<!-- Chrome -->
  <link rel="icon" sizes="192x192" href="/ovirt-site/previews/2719/images/favicon-192x192.png">
  <link rel="icon" sizes="96x96" href="/ovirt-site/previews/2719/images/favicon-96x96.png">
  <link rel="icon" sizes="48x48" href="/ovirt-site/previews/2719/images/favicon-48x48.png">
<link rel="manifest" href="/ovirt-site/previews/2719/manifest.webmanifest">
<!-- IE -->
<meta name="msapplication-TileColor" content="#ffffff">
<meta name="msapplication-TileImage" content="/ovirt-site/previews/2719/images/favicon-144x144.png">
<meta name='msapplication-config' content="/ovirt-site/previews/2719/browserconfig.xml">
<!-- End Jekyll Favicon tag -->
</head>
<body class=""><header class='masthead hidden-print' id='branding' role='banner'><section class='hgroup'></section><div id='access'><nav id="mainNav" class="navbar navbar-fixed-top affix-top">  <div class="container">    <div class="col-sm-2 navbar-header">      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#menu_id0980fddf">        <span class="sr-only">Toggle navigation</span>        <span>Menu</span>        <span class="fa fa-bars"></span>      </button>      <a class="navbar-brand" href="/ovirt-site/previews/2719/">        <img id="logo" alt="oVirt" src="/ovirt-site/previews/2719/images/logo.svg">      </a>    </div>    <!-- Collect the nav links, forms, and other content for toggling -->    <div class="col-sm-10">      <div class="navbar-collapse collapse" id="menu_id0980fddf">        <ul class="nav navbar-nav">          <li class="hidden active">            <a href="#page-wrap"></a>          </li><li role='menuitem'>  <a href='/ovirt-site/previews/2719/download/'>Download</a></li><li class='active' role='menuitem'>  <a href='/ovirt-site/previews/2719/documentation/'>Documentation</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/2719/develop/'>Developers</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/2719/community/'>Community</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/2719//lists.ovirt.org/archives/'>Forum</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/2719//blogs.ovirt.org/'>Blog</a></li>              </ul>          </div>          <!-- /.navbar-collapse -->      </div>      <!-- /.container-fluid -->    </div>  </div></nav></div></header><main id="page-wrap" class="page-wrap" aria-label="Content">
      <section id="page" class="page">
        <!-- adapted from https://github.com/git-no/jekyll-breadcrumbs -->
<nav class="breadcrumbs bootstrap hidden-sm-down" aria-label="breadcrumb">

   <ol class="breadcrumb list-unstyled" vocab="http://schema.org/" typeof="BreadcrumbList">

      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/2719/">
              <span property="name"></span>
              <meta property="position" content="1" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/2719/documentation/">
              <span property="name">Documentation</span>
              <meta property="position" content="2" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/2719/documentation/assembly-Setting_up_a_gpu_on_a_vm/">
              <span property="name">Assembly Setting Up A Gpu On A Vm</span>
              <meta property="position" content="3" />
           </a>
        </li>
      
        
        
          

   </ol>

</nav>

        
          
        
        <section id="content" class="content container">
          
<div id="assembly_managing-nvidia-vgpu-devices_{context}" class="paragraph">
<p>You can assign a GPU to a virtual machine in one of the following ways:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>GPU passthrough</strong>: You can assign a host GPU to a single virtual machine, so the virtual machine, instead of the host, uses the GPU.</p>
</li>
<li>
<p><strong>Virtual GPU (vGPU)</strong>: You can divide a physical GPU device into one or more virtual devices, referred to as <em>mediated devices</em>. You can then assign these mediated devices to one or more virtual machines as virtual GPUs. These virtual machines share the performance of a single physical GPU. For some GPUs, only one mediated device can be assigned to a single guest. vGPU support is only available on selected NVIDIA GPUs.</p>
<div class="paragraph">
<div class="title">Example:</div>
<p>A host has four GPUs. Each GPU can support up to 16 vGPUs, for a total of 64 vGPUs. Some possible vGPU assignments are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>one virtual machine with 64 vGPUs</p>
</li>
<li>
<p>64 virtual machines, each with one vGPU</p>
</li>
<li>
<p>32 virtual machines, each with one vGPU; eight virtual machines, each with two vGPUs; 4 virtual machines, each with four vGPUs</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="sect1">
<h2 id="proc_nvidia_gpu_passthrough_nvidia_gpu_passthrough">GPU device passthrough: Assigning a host GPU to a single virtual machine</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Red Hat Virtualization supports PCI VFIO, also called device passthrough, for some NVIDIA PCIe-based GPU devices as non-VGA graphics devices.</p>
</div>
<div class="paragraph">
<p>You can attach one or more host GPUs to a single virtual machine by passing through the host GPU to the virtual machine, in addition to one of the standard emulated graphics interfaces. The virtual machine uses the emulated graphics device for pre-boot and installation, and the GPU takes control when its graphics drivers are loaded.</p>
</div>
<div class="paragraph">
<p>For information on the exact number of host GPUs that you can pass through to a single virtual machine, see the NVIDIA website.</p>
</div>
<div class="paragraph">
<p>To assign a GPU to a virtual machine, follow the steps in these procedures:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="#Enabling_IOMMU_support_in_the_host_machine_kernel_nvidia_gpu_passthrough">Enable the I/O Memory Management Unit (IOMMU) on the host machine.</a></p>
</li>
<li>
<p><a href="#Detaching_the_GPU_device_from_the_host_nvidia_gpu_passthrough">Detach the GPU from the host.</a></p>
</li>
<li>
<p><a href="#Attaching_the_GPU_to_a_Virtual_Machine_nvidia_gpu_passthrough">Attach the GPU to the guest.</a></p>
</li>
<li>
<p><a href="#proc_install-nvidia-vgpu-guest-driver_nvidia_gpu_passthrough">Install GPU drivers on the guest.</a></p>
</li>
<li>
<p><a href="#Updating_and_Enabling_xorg_nvidia_gpu_passthrough">Configure Xorg on the guest.</a></p>
</li>
</ol>
</div>
<div class="paragraph">
<p>These steps are detailed below.</p>
</div>
<div id="prerequisites_nvidia_gpu_passthrough" class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>Your GPU device supports GPU passthrough mode.</p>
</li>
<li>
<p>Your system is listed as a validated server hardware platform.</p>
</li>
<li>
<p>Your host chipset supports Intel VT-d or AMD-Vi</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>For more information about supported hardware and software, see <a href="https://docs.nvidia.com/grid/latest/grid-vgpu-release-notes-red-hat-el-kvm/index.html#validated-platforms">Validated Platforms</a> in the <em>NVIDIA GPU Software Release Notes</em>.</p>
</div>
<div class="sect2">
<h3 id="Enabling_IOMMU_support_in_the_host_machine_kernel_nvidia_gpu_passthrough">Enabling host IOMMU support and blacklisting nouveau</h3>
<div class="paragraph">
<p>I/O Memory Management Unit (IOMMU) support on the host machine is necessary to use a GPU on a virtual machine.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>In the Administration Portal, click <span class="menuseq"><b class="menu">Compute</b>&#160;<i class="fa fa-angle-right caret"></i> <b class="menuitem">Hosts</b></span>. Select a host and click <b class="button">Edit</b>. The <strong>Edit Hosts</strong> pane appears.</p>
</li>
<li>
<p>Click the <strong>Kernel</strong> tab.</p>
</li>
<li>
<p>Check the <strong>Hostdev Passthrough &amp; SR-IOV</strong> checkbox. This checkbox enables IOMMU support for a host with Intel VT-d or AMD Vi by adding <code>intel_iommu=on</code> or <code>amd_iommu=on</code> to the kernel command line.</p>
</li>
<li>
<p>Check the <strong>Blacklist Nouveau</strong> checkbox.</p>
</li>
<li>
<p>Click <b class="button">OK</b>.</p>
</li>
<li>
<p>Select the host and click <span class="menuseq"><b class="menu">Management</b>&#160;<i class="fa fa-angle-right caret"></i> <b class="menuitem">Maintenance</b></span> and <b class="button">OK</b>.</p>
</li>
<li>
<p>Click <span class="menuseq"><b class="menu">Installation</b>&#160;<i class="fa fa-angle-right caret"></i> <b class="menuitem">Reinstall</b></span>.</p>
</li>
<li>
<p>After the reinstallation is finished, reboot the host machine.</p>
</li>
<li>
<p>When the host machine has rebooted, click <span class="menuseq"><b class="menu">Management</b>&#160;<i class="fa fa-angle-right caret"></i> <b class="menuitem">Activate</b></span>.</p>
</li>
</ol>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>To enable IOMMU support using the command line, edit the <code>grub.conf</code> file in the virtual machine (./entries/rhvh-4.4.&lt;machine id&gt;.conf) to include the option <code>intel_iommu=on</code>.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="Detaching_the_GPU_device_from_the_host_nvidia_gpu_passthrough">Detaching the GPU from the host</h3>
<div class="paragraph">
<p>You cannot add the GPU to the virtual machine if the GPU is bound to the host kernel driver, so you must unbind the GPU device from the host before you can add it to the virtual machine. Host drivers often do not support dynamic unbinding of the GPU, so it is recommended to manually exclude the device from binding to the host drivers.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>On the host, identify the device slot name and IDs of the device by running the <code class="command">lspci</code> command. In the following example, a graphics controller such as an NVIDIA Quadro or GRID card is used:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># lspci -Dnn | grep -i NVIDIA
0000:03:00.0 VGA compatible controller [0300]: NVIDIA Corporation GK104GL [Quadro K4200] [10de:11b4] (rev a1)
0000:03:00.1 Audio device [0403]: NVIDIA Corporation GK104 HDMI Audio Controller [10de:0e0a] (rev a1)</pre>
</div>
</div>
<div class="paragraph">
<p>The output shows that the NVIDIA GK104 device is installed. It has a graphics controller and an audio controller with the following properties:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The device slot name of the graphics controller is <code>0000:03:00.0</code>, and the vendor-id:device-id for the graphics controller are <code>10de:11b4</code>.</p>
</li>
<li>
<p>The device slot name of the audio controller is <code>0000:03:00.1</code>, and the vendor-id:device-id for the audio controller are <code>10de:0e0a</code>.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Prevent the host machine driver from using the GPU device. You can use a vendor-id:device-id with the pci-stub driver. To do this, append the <code>pci-stub.ids</code> option, with the vendor-id:device-id as its value, to the <code>GRUB_CMDLINX_LINUX</code> environment variable located in the <code>/etc/sysconfig/grub</code> configuration file, for example:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">GRUB_CMDLINE_LINUX="crashkernel=auto resume=/dev/mapper/vg0-lv_swap rd.lvm.lv=vg0/lv_root rd.lvm.lv=vg0/lv_swap rhgb quiet intel_iommu=on pci-stub.ids=10de:11b4,10de:0e0a"</pre>
</div>
</div>
<div class="paragraph">
<p>When adding additional vendor IDs and device IDs for pci-stub, separate them with a comma.</p>
</div>
</li>
<li>
<p>Regenerate the boot loader configuration using grub2-mkconfig to include this option:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># grub2-mkconfig -o /etc/grub2.cfg</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>When using a UEFI-based host, the target file should be <code class="filename">/etc/grub2-efi.cfg</code>.</p>
</div>
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Reboot the host machine.</p>
</li>
<li>
<p>Confirm that IOMMU is enabled, the host device is added to the list of pci-stub.ids, and Nouveau is blacklisted:</p>
<div class="literalblock">
<div class="content">
<pre class="nowrap"># cat /proc/cmdline
BOOT_IMAGE=(hd0,msdos1)/vmlinuz-4.18.0-147.el8.x86_64 root=/dev/mapper/vg0-lv_root ro crashkernel=auto resume=/dev/mapper/vg0-lv_swap rd.lvm.lv=vg0/lv_root rd.lvm.lv=vg0/lv_swap rhgb quiet <strong>intel_iommu=on</strong> <i class="conum" data-value="1"></i><b>(1)</b>
<strong>pci-stub.ids=10de:11b4,10de:0e0a</strong> <i class="conum" data-value="2"></i><b>(2)</b>
<strong>rdblacklist=nouveau</strong> <i class="conum" data-value="3"></i><b>(3)</b></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>IOMMU is enabled</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>the host device is added to the list of pci-stub.ids</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Nouveau is blacklisted</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="Attaching_the_GPU_to_a_Virtual_Machine_nvidia_gpu_passthrough">Attaching the GPU to a Virtual Machine</h3>
<div class="paragraph">
<p>After unbinding the GPU from host kernel driver, you can add it to the virtual machine and enable the correct driver.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Follow the steps in <a href="{URL_virt_product_docs}{URL_format}virtual_machine_management_guide/index#Adding_Host_Devices_to_a_Virtual_Machine">Adding a Host Device to a Virtual Machine</a> in the <em>Virtual Machine Management Guide</em>.</p>
</li>
<li>
<p>Run the virtual machine and log in to it.</p>
</li>
<li>
<p>Install the NVIDIA GPU driver on the virtual machine. For details, see <a href="#proc_install-nvidia-vgpu-guest-driver_nvidia_gpu_passthrough">Installing the GPU driver on the virtual machine</a>.</p>
</li>
<li>
<p>Verify that the correct kernel driver is in use for the GPU with the <code class="command">lspci -nnk</code> command. For example:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># lspci -nnk
00:07.0 VGA compatible controller [0300]: NVIDIA Corporation GK104GL [Quadro K4200] [10de:11b4] (rev a1)
Subsystem: Hewlett-Packard Company Device [103c:1096]
Kernel driver in use: nvidia
Kernel modules: nouveau, nvidia_drm, nvidia</pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="proc_install-nvidia-vgpu-guest-driver_nvidia_gpu_passthrough">Installing the GPU driver on the virtual machine</h3>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Run the virtual machine and connect to it using the VNC or SPICE console.</p>
</li>
<li>
<p>Download the driver to the virtual machine. For information on getting the driver, see <a href="https://www.nvidia.com/Download/index.aspx?lang=en-us">the Drivers page on the NVIDIA website</a>.</p>
</li>
<li>
<p>Install the GPU driver.</p>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p><strong>Linux only:</strong> When installing the driver on a Linux guest operating system, you are prompted to update xorg.conf. If you do not update xorg.conf during the installation, you need to update it manually.
For more information, see <a href="#Updating_and_Enabling_xorg_nvidia_gpu_passthrough">Updating and Enabling xorg (Linux Virtual Machines)</a>.</p>
</div>
</td>
</tr>
</table>
</div>
</li>
<li>
<p>After the driver finishes installing, reboot the machine. <strong>For Windows virtual machines,</strong> fully power off the guest from the Administration portal or the VM portal, not from within the guest operating system.</p>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p><strong>Windows only:</strong> Powering off the virtual machine from within the Windows guest operating system sometimes sends the virtual machine into hibernate mode, which does not completely clear the memory, possibly leading to subsequent problems. Using the Administration portal or the VM portal to power off the virtual machine forces it to fully clean the memory.</p>
</div>
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Connect a monitor to the host GPU output interface and run the virtual machine.</p>
</li>
<li>
<p>Set up NVIDIA vGPU guest software licensing for each vGPU and add the license credentials in the NVIDIA control panel. For more information, see  <a href="https://docs.nvidia.com/grid/latest/grid-licensing-user-guide/index.html#how-grid-licensing-works">How NVIDIA vGPU Software Licensing Is Enforced</a> in the <em>NVIDIA Virtual GPU Software Documentation</em>.</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="Updating_and_Enabling_xorg_nvidia_gpu_passthrough">Updating and Enabling xorg (Linux Virtual Machines)</h3>
<div class="paragraph">
<p>Before you can use the GPU on the virtual machine, you need to update and enable xorg on the virtual machine. The NVIDIA driver installation should do this automatically. Check if xorg is updated and enabled by viewing <code class="filename">/etc/X11/xorg.conf</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># cat /etc/X11/xorg.conf</pre>
</div>
</div>
<div class="paragraph">
<p>The first two lines say if it was generated by NVIDIA. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># cat /etc/X11/xorg.conf
# nvidia-xconfig: X configuration file generated by nvidia-xconfig
# nvidia-xconfig: version 390.87 (buildmeister@swio-display-x64-rhel04-14) Tue Aug 21 17:33:38 PDT 2018</pre>
</div>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>On the virtual machine, generate the <code>xorg.conf</code> file using following command:</p>
<div class="listingblock">
<div class="content">
<pre># X -configure</pre>
</div>
</div>
</li>
<li>
<p>Copy the <code>xorg.conf</code> file to <code>/etc/X11/xorg.conf</code> using the following command:</p>
<div class="listingblock">
<div class="content">
<pre># cp /root/xorg.conf.new /etc/X11/xorg.conf</pre>
</div>
</div>
</li>
<li>
<p>Reboot the virtual machine.</p>
</li>
<li>
<p>Verify that xorg is updated and enabled by viewing <code class="filename">/etc/X11/xorg.conf</code>:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># cat /etc/X11/xorg.conf</pre>
</div>
</div>
<div class="paragraph">
<p>Search for the <strong><code>Device</code></strong> section. You should see an entry similar to the following section:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">Section "Device"
    Identifier     "Device0"
    Driver         "nvidia"
    VendorName     "NVIDIA Corporation"
EndSection</pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>The GPU is now assigned to the virtual machine.</p>
</div>
</div>
<div class="sect2">
<h3 id="related-information_nvidia_gpu_passthrough">Removing a host GPU from a virtual machine</h3>
<div class="ulist">
<ul>
<li>
<p>For information on removing a host GPU from a virtual machine, see <a href="{URL_virt_product_docs}{URL_format}virtual_machine_management_guide/index#Removing_Host_Devices_from_a_Virtual_Machine">Removing Host Devices from a Virtual Machine</a> in the <em>Virtual Machine Management Guide</em>.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="assigning-virtual-gpus">Assigning virtual GPUs</h2>
<div class="sectionbody">
<div class="paragraph">
<p>To set up NVIDIA vGPU devices, you need to:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Obtain and install the correct NVIDIA vGPU driver for your GPU device</p>
</li>
<li>
<p>Create mediated devices</p>
</li>
<li>
<p>Assign each mediated device to a virtual machine</p>
</li>
<li>
<p>Install guest drivers on each virtual machine.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The following procedures explain this process.</p>
</div>
<div class="sect2">
<h3 id="proc_setting-up-nvidia-vgpu-devices_nvidia_vgpu">Setting up NVIDIA vGPU devices on the host</h3>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Before installing the NVIDIA vGPU driver on the guest operating system, you need to understand the licensing requirements and obtain the correct license credentials.</p>
</div>
</td>
</tr>
</table>
</div>
<div id="prerequisites-nvidia_vgpu" class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>Your GPU device supports virtual GPU (vGPU) functionality.</p>
</li>
<li>
<p>Your system is listed as a validated server hardware platform.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>For more information about supported GPUs and validated platforms, see <a href="https://www.nvidia.com/en-us/data-center/resources/vgpu-certified-servers/">NVIDIA vGPU CERTIFIED SERVERS</a> on www.nvidia.com.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Download and install the NVIDIA driver for the host. For information on getting the driver, see <a href="https://www.nvidia.com/Download/index.aspx?lang=en-us">the Drivers page on the NVIDIA website</a>.</p>
</li>
<li>
<p>If the NVIDIA software installer did not create the <code class="filename">/etc/modprobe.d/nvidia-installer-disable-nouveau.conf</code> file, create it manually.</p>
</li>
<li>
<p>Open <code class="filename">/etc/modprobe.d/nvidia-installer-disable-nouveau.conf</code> file in a text editor and add the following lines to the end of the file:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">blacklist nouveau
options nouveau modeset=0</code></pre>
</div>
</div>
</li>
<li>
<p>Regenerate the initial ramdisk for the current kernel, then reboot:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash"># <strong>dracut --force</strong>
# <strong>reboot</strong></code></pre>
</div>
</div>
<div class="paragraph">
<p>Alternatively, if you need to use a prior supported kernel version with mediated devices, regenerate the initial ramdisk for all installed kernel versions:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash"># <strong>dracut --regenerate-all --force</strong>
# <strong>reboot</strong></code></pre>
</div>
</div>
</li>
<li>
<p>Check that the kernel loaded the <code class="filename">nvidia_vgpu_vfio</code> module:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash"># lsmod | grep nvidia_vgpu_vfio</code></pre>
</div>
</div>
</li>
<li>
<p>Check that the <code>nvidia-vgpu-mgr.service</code> service is running:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash"># systemctl status nvidia-vgpu-mgr.service</code></pre>
</div>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash"># lsmod | grep nvidia_vgpu_vfio
nvidia_vgpu_vfio 45011 0
nvidia 14333621 10 nvidia_vgpu_vfio
mdev 20414 2 vfio_mdev,nvidia_vgpu_vfio
vfio 32695 3 vfio_mdev,nvidia_vgpu_vfio,vfio_iommu_type1
# systemctl status nvidia-vgpu-mgr.service
nvidia-vgpu-mgr.service - NVIDIA vGPU Manager Daemon
   Loaded: loaded (/usr/lib/systemd/system/nvidia-vgpu-mgr.service; enabled; vendor preset: disabled)
   Active: active (running) since Fri 2018-03-16 10:17:36 CET; 5h 8min ago
 Main PID: 1553 (nvidia-vgpu-mgr)
 [...]</code></pre>
</div>
</div>
</li>
<li>
<p>In the Administration Portal, click <span class="menuseq"><b class="menu">Compute</b>&#160;<i class="fa fa-angle-right caret"></i> <b class="menuitem">Virtual Machines</b></span>.</p>
</li>
<li>
<p>Click the name of the virtual machine to go to the details view.</p>
</li>
<li>
<p>Click the <strong>Host Devices</strong> tab.</p>
</li>
<li>
<p>Click the <b class="button">Manage vGPU</b> button. The <strong>Manage vGPU</strong> dialog box opens.</p>
</li>
<li>
<p>Select a vGPU type and the number of instances that you would like to use with this virtual machine.</p>
</li>
<li>
<p>Select <strong>On</strong> for <strong>Secondary display adapter for VNC</strong> to add a second emulated QXL or VGA graphics adapter as the primary graphics adapter for the console in addition to the vGPU.</p>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>On cluster levels 4.5 and later, when a vGPU is used and the <strong>Secondary display adapter for VNC</strong> is set to <strong>On</strong>, an additional framebuffer display device is automatically added to the virtual machine. This allows the virtual machine console to be displayed before the vGPU is initialized, instead of a blank screen.</p>
</div>
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Click <b class="button">Save</b>.</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="proc_install-nvidia-vgpu-guest-driver_nvidia_vgpu">Installing the vGPU driver on the virtual machine</h3>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Run the virtual machine and connect to it using the VNC console.</p>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>SPICE is not supported on vGPU.</p>
</div>
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Download the driver to the virtual machine. For information on getting the driver, see <a href="https://www.nvidia.com/Download/index.aspx?lang=en-us">the Drivers page on the NVIDIA website</a>.</p>
</li>
<li>
<p>Install the vGPU driver, following the instructions in <a href="https://docs.nvidia.com/grid/latest/grid-vgpu-user-guide/index.html#installing-grid-vgpu-display-drivers">Installing the NVIDIA vGPU Software Graphics Driver</a> in the <em>NVIDIA Virtual GPU software documentation</em>.</p>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p><strong>Linux only:</strong> When installing the driver on a Linux guest operating system, you are prompted to update xorg.conf. If you do not update xorg.conf during the installation, you need to update it manually.
For more information, see <a href="#Updating_and_Enabling_xorg_nvidia_gpu_passthrough">Updating and Enabling xorg (Linux Virtual Machines)</a>.</p>
</div>
</td>
</tr>
</table>
</div>
</li>
<li>
<p>After the driver finishes installing, reboot the machine. <strong>For Windows virtual machines,</strong> fully power off the guest from the Administration portal or the VM portal, not from within the guest operating system.</p>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p><strong>Windows only:</strong> Powering off the virtual machine from within the Windows guest operating system sometimes sends the virtual machine into hibernate mode, which does not completely clear the memory, possibly leading to subsequent problems. Using the Administration portal or the VM portal to power off the virtual machine forces it to fully clean the memory.</p>
</div>
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Run the virtual machine and connect to it using one of the supported remote desktop protocols, such as Mechdyne TGX, and verify that the vGPU is recognized by opening the NVIDIA Control Panel. On Windows, you can alternatively open the Windows Device Manager. The vGPU should appear under <strong>Display adapters</strong>. For more information, see the <a href="https://docs.nvidia.com/grid/latest/grid-vgpu-user-guide/index.html#installing-grid-vgpu-display-drivers">NVIDIA vGPU Software Graphics Driver</a> in the <em>NVIDIA Virtual GPU software documentation</em>.</p>
</li>
<li>
<p>Set up NVIDIA vGPU guest software licensing for each vGPU and add the license credentials in the NVIDIA control panel. For more information, see  <a href="https://docs.nvidia.com/grid/latest/grid-licensing-user-guide/index.html#how-grid-licensing-works">How NVIDIA vGPU Software Licensing Is Enforced</a> in the <em>NVIDIA Virtual GPU Software Documentation</em>.</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="proc_removing-nvidia-vgpu-devices_nvidia_vgpu">Removing NVIDIA vGPU devices</h3>
<div class="paragraph">
<p>To change the configuration of assigned vGPU mediated devices, the existing devices have to be removed from the assigned guests.</p>
</div>
<div class="olist discrete">
<div class="title">Procedure</div>
<ol class="discrete">
<li>
<p>In the Administration Portal, click <span class="menuseq"><b class="menu">Compute</b>&#160;<i class="fa fa-angle-right caret"></i> <b class="menuitem">Virtual Machines</b></span>.</p>
</li>
<li>
<p>Click the name of the virtual machine to go to the details view.</p>
</li>
<li>
<p>Click the <strong>Host Devices</strong> tab.</p>
</li>
<li>
<p>Click the <b class="button">Manage vGPU</b> button. The <strong>Manage vGPU</strong> dialog box opens.</p>
</li>
<li>
<p>Click the <b class="button">x</b> button next to <strong>Selected vGPU Type Instances</strong> to detach the vGPU from the virtual machine.</p>
</li>
<li>
<p>Click <b class="button">SAVE</b>.</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="proc_obtaining-nvidia-vgpu-information-about-your-system_nvidia_vgpu">Monitoring NVIDIA vGPUs</h3>
<div class="paragraph">
<p>For NVIDIA vGPUS, to get info on the physical GPU and vGPU, you can use the NVIDIA System Management Interface by entering the <code class="command">nvidia-smi</code> command on the host. For more information, see <a href="https://docs.nvidia.com/grid/latest/grid-vgpu-user-guide/index.html#performance-monitoring-gpu-nvidia-smi">NVIDIA System Management Interface nvidia-smi</a> in the <em>NVIDIA Virtual GPU Software Documentation</em>.</p>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># nvidia-smi
Thu Nov  1 17:40:09 2018
+-----------------------------------------------------------------------------+
| NVIDIA-SMI 410.62                 Driver Version: 410.62                    |
|-------------------------------+----------------------+----------------------+
| GPU  Name        Persistence-M| Bus-Id        Disp.A | Volatile Uncorr. ECC |
| Fan  Temp  Perf  Pwr:Usage/Cap|         Memory-Usage | GPU-Util  Compute M. |
|===============================+======================+======================|
|   0  Tesla M60           On   | 00000000:84:00.0 Off |                  Off |
| N/A   40C    P8    24W / 150W |   1034MiB /  8191MiB |      0%      Default |
+-------------------------------+----------------------+----------------------+
|   1  Tesla M60           On   | 00000000:85:00.0 Off |                  Off |
| N/A   33C    P8    23W / 150W |   8146MiB /  8191MiB |      0%      Default |
+-------------------------------+----------------------+----------------------+
|   2  Tesla M60           On   | 00000000:8B:00.0 Off |                  Off |
| N/A   34C    P8    24W / 150W |   8146MiB /  8191MiB |      0%      Default |
+-------------------------------+----------------------+----------------------+
|   3  Tesla M60           On   | 00000000:8C:00.0 Off |                  Off |
| N/A   45C    P8    24W / 150W |     18MiB /  8191MiB |      0%      Default |
+-------------------------------+----------------------+----------------------+

+-----------------------------------------------------------------------------+
| Processes:                                                       GPU Memory |
|  GPU       PID   Type   Process name                             Usage      |
|=============================================================================|
|    0     34432    C+G   vgpu                                         508MiB |
|    0     34718    C+G   vgpu                                         508MiB |
|    1     35032    C+G   vgpu                                        8128MiB |
|    2     35032    C+G   vgpu                                        8128MiB |
+-----------------------------------------------------------------------------+</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="ref_remote-desktop-streaming-services-for-nvidia-vgpu_nvidia_vgpu">Remote desktop streaming services for NVIDIA vGPU</h3>
<div class="paragraph">
<p>The following remote desktop streaming services have been successfully tested for use with the NVIDIA vGPU feature in RHEL 8:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>HP-RGS</p>
</li>
<li>
<p>Mechdyne TGX - It is currently not possible to use Mechdyne TGX with Windows Server 2016 guests.</p>
</li>
<li>
<p>NICE DCV - When using this streaming service, use fixed resolution settings, because using dynamic resolution in some cases results in a black screen.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="related-information-general_nvidia_vgpu">Related information</h2>
<div class="sectionbody">
<div class="paragraph">
<p>For further information on using NVIDA vGPU on RHEL with KVM, see:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://docs.nvidia.com/grid/latest/grid-vgpu-release-notes-red-hat-el-kvm/index.html">the NVIDIA GPU Software Release Notes</a>.</p>
</li>
<li>
<p><em>NVIDIA Virtual GPU Software Documentation</em> at <a href="https://docs.nvidia.com" class="bare">https://docs.nvidia.com</a>.</p>
</li>
</ul>
</div>
</div>
</div>



        </section>
      </section>
    </main>

    <script src="/ovirt-site/previews/2719/javascripts/lib/headings_anchors.js" type="text/javascript"></script><footer class='text-center' id='footer'><hr class='visible-print'><ul class='footer-nav-list'><li><a href='/ovirt-site/previews/2719/privacy-policy.html' target='_blank' title='Privacy policy'>Privacy policy</a></li><li><a href='/ovirt-site/previews/2719/community/about.html' target='_blank' title='About'>About</a></li><li><a href='/ovirt-site/previews/2719/general-disclaimer.html' target='_blank' title='Disclaimers'>Disclaimers</a></li></ul>&copy; 2013&ndash;2022 oVirt<div class='edit-this-page'><a href='https://github.com/oVirt/ovirt-site/issues/new?labels=documentation&amp;title=Issue:%20/documentation/assembly-Setting_up_a_gpu_on_a_vm/assembly_managing-nvidia-vgpu-devices.html&amp;template=issue_template_documentation.md' target='_blank' title='Report an issue'><i class="icon fab fa-github"></i>Report an issue with this page</a></div><div class='edit-this-page'><a href='https://github.com/oVirt/ovirt-site/edit/master/source/documentation/assembly-Setting_up_a_gpu_on_a_vm/assembly_managing-nvidia-vgpu-devices.adoc' target='_blank' title='Edit this page'><i class="icon fab fa-github"></i>Edit this page</a></div></footer></body>

</html>
