<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <!-- Begin Jekyll SEO tag v2.7.1 -->
<title>Virtual Machine Snapshots | oVirt</title>
<meta name="generator" content="Jekyll v3.9.1" />
<meta property="og:title" content="Virtual Machine Snapshots" />
<meta property="og:locale" content="en" />
<meta name="description" content="oVirt is a free open-source virtualization solution for your entire enterprise" />
<meta property="og:description" content="oVirt is a free open-source virtualization solution for your entire enterprise" />
<link rel="canonical" href="https://ovirt.github.io/ovirt-site/previews/2771/documentation/doc-Technical_Reference/chap-Virtual_Machine_Snapshots.html" />
<meta property="og:url" content="https://ovirt.github.io/ovirt-site/previews/2771/documentation/doc-Technical_Reference/chap-Virtual_Machine_Snapshots.html" />
<meta property="og:site_name" content="oVirt" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Virtual Machine Snapshots" />
<meta name="twitter:site" content="@ovirt" />
<script type="application/ld+json">
{"publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"https://ovirt.github.io/ovirt-site/previews/2771/images/logo.svg"}},"description":"oVirt is a free open-source virtualization solution for your entire enterprise","@type":"WebPage","headline":"Virtual Machine Snapshots","url":"https://ovirt.github.io/ovirt-site/previews/2771/documentation/doc-Technical_Reference/chap-Virtual_Machine_Snapshots.html","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->

  <meta name="viewport" content="initial-scale=1.0,user-scalable=no,maximum-scale=1,width=device-width">
  <link rel="stylesheet" href="/ovirt-site/previews/2771/stylesheets/fonts.css" />
  <link rel='stylesheet' href='https://fonts.googleapis.com/css?family=Open+Sans'>
  <link rel="stylesheet" href="/ovirt-site/previews/2771/stylesheets/application.css" />
  <link rel="stylesheet" href="/ovirt-site/previews/2771/stylesheets/print.css" media="print" />
  <link rel="stylesheet" href="/ovirt-site/previews/2771/stylesheets/coderay.css" media="screen" />
  <link rel="stylesheet" href="/ovirt-site/previews/2771/stylesheets/asciidoc.css" />
  <script src="/ovirt-site/previews/2771/javascripts/vendor/jquery.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/2771/javascripts/vendor/bootstrap.min.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/2771/javascripts/vendor/bootstrap-sortable.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/2771/javascripts/vendor/moment.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/2771/javascripts/vendor/fullcalendar/fullcalendar.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/2771/javascripts/lib/cal-widget.js" type="text/javascript"></script>
  <!-- Begin Jekyll Favicon tag v0.2.9 -->
<!-- Classic -->
<link rel="shortcut icon" href="/ovirt-site/previews/2771/favicon.ico">
<link rel="icon" sizes="48x48 32x32 16x16" href="/ovirt-site/previews/2771/favicon.ico">
  <link rel="icon" sizes="16x16" type="image/png" href="/ovirt-site/previews/2771/images/favicon-16x16.png">
  <link rel="icon" sizes="32x32" type="image/png" href="/ovirt-site/previews/2771/images/favicon-32x32.png">
  <link rel="icon" sizes="64x64" type="image/png" href="/ovirt-site/previews/2771/images/favicon-64x64.png">
  <link rel="icon" sizes="144x144" type="image/png" href="/ovirt-site/previews/2771/images/favicon-144x144.png">
<!-- Safari -->
  <link rel="apple-touch-icon" sizes="57x57" href="/ovirt-site/previews/2771/images/favicon-57x57.png">
  <link rel="apple-touch-icon" sizes="76x76" href="/ovirt-site/previews/2771/images/favicon-76x76.png">
  <link rel="apple-touch-icon" sizes="120x120" href="/ovirt-site/previews/2771/images/favicon-120x120.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/ovirt-site/previews/2771/images/favicon-152x152.png">
  <link rel="apple-touch-icon" sizes="167x167" href="/ovirt-site/previews/2771/images/favicon-167x167.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/ovirt-site/previews/2771/images/favicon-180x180.png">
<!-- Chrome -->
  <link rel="icon" sizes="192x192" href="/ovirt-site/previews/2771/images/favicon-192x192.png">
  <link rel="icon" sizes="96x96" href="/ovirt-site/previews/2771/images/favicon-96x96.png">
  <link rel="icon" sizes="48x48" href="/ovirt-site/previews/2771/images/favicon-48x48.png">
<link rel="manifest" href="/ovirt-site/previews/2771/manifest.webmanifest">
<!-- IE -->
<meta name="msapplication-TileColor" content="#ffffff">
<meta name="msapplication-TileImage" content="/ovirt-site/previews/2771/images/favicon-144x144.png">
<meta name='msapplication-config' content="/ovirt-site/previews/2771/browserconfig.xml">
<!-- End Jekyll Favicon tag -->
</head>
<body class=""><header class='masthead hidden-print' id='branding' role='banner'><section class='hgroup'></section><div id='access'><nav id="mainNav" class="navbar navbar-fixed-top affix-top">  <div class="container">    <div class="col-sm-2 navbar-header">      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#menu_id0980fddf">        <span class="sr-only">Toggle navigation</span>        <span>Menu</span>        <span class="fa fa-bars"></span>      </button>      <a class="navbar-brand" href="/ovirt-site/previews/2771/">        <img id="logo" alt="oVirt" src="/ovirt-site/previews/2771/images/logo.svg">      </a>    </div>    <!-- Collect the nav links, forms, and other content for toggling -->    <div class="col-sm-10">      <div class="navbar-collapse collapse" id="menu_id0980fddf">        <ul class="nav navbar-nav">          <li class="hidden active">            <a href="#page-wrap"></a>          </li><li role='menuitem'>  <a href='/ovirt-site/previews/2771/download/'>Download</a></li><li class='active' role='menuitem'>  <a href='/ovirt-site/previews/2771/documentation/'>Documentation</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/2771/develop/'>Developers</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/2771/community/'>Community</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/2771//lists.ovirt.org/archives/'>Forum</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/2771//blogs.ovirt.org/'>Blog</a></li>              </ul>          </div>          <!-- /.navbar-collapse -->      </div>      <!-- /.container-fluid -->    </div>  </div></nav></div></header><main id="page-wrap" class="page-wrap" aria-label="Content">
      <section id="page" class="page">
        <!-- adapted from https://github.com/git-no/jekyll-breadcrumbs -->
<nav class="breadcrumbs bootstrap hidden-sm-down" aria-label="breadcrumb">

   <ol class="breadcrumb list-unstyled" vocab="http://schema.org/" typeof="BreadcrumbList">

      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/2771/">
              <span property="name"></span>
              <meta property="position" content="1" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/2771/documentation/">
              <span property="name">Documentation</span>
              <meta property="position" content="2" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/2771/documentation/doc-Technical_Reference/">
              <span property="name">Technical Reference</span>
              <meta property="position" content="3" />
           </a>
        </li>
      
        
        
          

   </ol>

</nav>

        
          
        
        <section id="content" class="content container">
          
<div class="sect1">
<h2 id="Snapshots1">Snapshots</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Snapshots are a storage function that allows an administrator to create a restore point of a virtual machine&#8217;s operating system, applications, and data at a certain point in time. Snapshots save the data currently present in a virtual machine hard disk image as a COW volume and allow for a recovery to the data as it existed at the time the snapshot was taken. A snapshot causes a new COW layer to be created over the current layer. All write actions performed after a snapshot is taken are written to the new COW layer.</p>
</div>
<div class="paragraph">
<p>It is important to understand that a virtual machine hard disk image is a chain of one or more volumes. From the perspective of a virtual machine, these volumes appear as a single disk image. A virtual machine is oblivious to the fact that its disk is comprised of multiple volumes.</p>
</div>
<div class="paragraph">
<p>The term COW volume and COW layer are used interchangeably, however, layer more clearly recognizes the temporal nature of snapshots. Each snapshot is created to allow an administrator to discard unsatisfactory changes made to data <strong>after</strong> the snapshot is taken. Snapshots provide similar functionality to the <strong>Undo</strong> function present in many word processors.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Snapshots of virtual machine hard disks marked <strong>shareable</strong> and those that are based on <strong>Direct LUN</strong> connections are not supported, live or otherwise.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The three primary snapshot operations are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Creation, which involves the first snapshot created for a virtual machine.</p>
</li>
<li>
<p>Previews, which involves previewing a snapshot to determine whether or not to restore the system data to the point in time that the snapshot was taken.</p>
</li>
<li>
<p>Deletion, which involves deleting a restoration point that is no longer required.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>For task-based information about snapshot operations, see <a href="{URL_virt_product_docs}{URL_format}virtual_machine_management_guide#sect-Snapshots">Snapshots</a> in the <em>{virt-product-fullname} Virtual Machine Management Guide</em>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="Live_Snapshots_in_Red_Hat_Enterprise_Virtualization">Live Snapshots in {virt-product-fullname}</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Snapshots of virtual machine hard disks marked <strong>shareable</strong> and those that are based on <strong>Direct LUN</strong> connections are not supported, live or otherwise.</p>
</div>
<div class="paragraph">
<p>Any other virtual machine that is not being cloned or migrated can have a snapshot taken when running, paused, or stopped.</p>
</div>
<div class="paragraph">
<p>When a live snapshot of a virtual machine is initiated, the {engine-name} requests that the SPM host create a new volume for the virtual machine to use. When the new volume is ready, the {engine-name} uses VDSM to communicate with libvirt and qemu on the host running the virtual machine that it should begin using the new volume for virtual machine write operations. If the virtual machine is able to write to the new volume, the snapshot operation is considered a success and the virtual machine stops writing to the previous volume. If the virtual machine is unable to write to the new volume, the snapshot operation is considered a failure, and the new volume is deleted.</p>
</div>
<div class="paragraph">
<p>The virtual machine requires access to both its current volume and the new one from the time when a live snapshot is initiated until after the new volume is ready, so both volumes are opened with read-write access.</p>
</div>
<div class="paragraph">
<p>Virtual machines with an installed guest agent that supports quiescing can ensure filesystem consistency across snapshots. Registered {enterprise-linux} guests can install the <strong>qemu-guest-agent</strong> to enable quiescing before snapshots.</p>
</div>
<div class="paragraph">
<p>If a quiescing compatible guest agent is present on a virtual machine when it a snapshot is taken, VDSM uses libvirt to communicate with the agent to prepare for a snapshot. Outstanding write actions are completed, and then filesystems are frozen before a snapshot is taken. When the snapshot is complete, and libvirt has switched the virtual machine to the new volume for disk write actions, the filesystem is thawed, and writes to disk resume.</p>
</div>
<div class="paragraph">
<p>All live snapshots attempted with quiescing enabled. If the snapshot command fails because there is no compatible guest agent present, the live snapshot is re-initiated without the use-quiescing flag. When a virtual machine is reverted to its pre-snapshot state with quiesced filesystems, it boots cleanly with no filesystem check required. Reverting the previous snapshot using an un-quiesced filesystem requires a filesystem check on boot.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="Snapshot_Creation">Snapshot Creation</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In {virt-product-fullname} the initial snapshot for a virtual machine is different from subsequent snapshots in that the initial snapshot retains its format, either QCOW2 or raw. The first snapshot for a virtual machine uses existing volumes as a base image. Additional snapshots are additional COW layers tracking the changes made to the data stored in the image since the previous snapshot.</p>
</div>
<div class="paragraph">
<p>As depicted in <a href="#figu-Technical_Reference_Guide-Snapshots-Initial_Snapshot_Creation">Initial Snapshot Creation</a>, the creation of a snapshot causes the volumes that comprise a virtual disk to serve as the base image for all subsequent snapshots.</p>
</div>
<div id="figu-Technical_Reference_Guide-Snapshots-Initial_Snapshot_Creation" class="imageblock">
<div class="content">
<img src="991.png" alt="991">
</div>
<div class="title">Figure 1. Initial Snapshot Creation</div>
</div>
<div class="paragraph">
<p>Snapshots taken after the initial snapshot result in the creation of new COW volumes in which data that is created or changed after the snapshot is taken will be stored. Each newly created COW layer contains only COW metadata. Data that is created by using and operating the virtual machine after a snapshot is taken is written to this new COW layer. When a virtual machine is used to modify data that exists in a previous COW layer, the data is read from the previous layer, and written into the newest layer. Virtual machines locate data by checking each COW layer from most recent to oldest, transparently to the virtual machine.</p>
</div>
<div id="figu-Technical_Reference_Guide-Snapshots-Additional_Snapshot_Creation" class="imageblock">
<div class="content">
<img src="982.png" alt="982">
</div>
<div class="title">Figure 2. Additional Snapshot Creation</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="Snapshot_Previews">Snapshot Previews</h2>
<div class="sectionbody">
<div class="paragraph">
<p>To select which snapshot a virtual disk will be reverted to, the administrator can preview all previously created snapshots.</p>
</div>
<div class="paragraph">
<p>From the available snapshots per guest, the administrator can select a snapshot volume to preview its contents. As depicted in <a href="#figu-Technical_Reference_Guide-Snapshots-Preview_Snapshot">Preview Snapshot</a>, each snapshot is saved as a COW volume, and when it is previewed, a new preview layer is copied from the snapshot being previewed. The guest interacts with the preview instead of the actual snapshot volume.</p>
</div>
<div class="paragraph">
<p>After the administrator previews the selected snapshot, the preview can be committed to restore the guest data to the state captured in the snapshot. If the administrator commits the preview, the guest is attached to the preview layer.</p>
</div>
<div class="paragraph">
<p>After a snapshot is previewed, the administrator can select <strong>Undo</strong> to discard the preview layer of the viewed snapshot. The layer that contains the snapshot itself is preserved despite the preview layer being discarded.</p>
</div>
<div id="figu-Technical_Reference_Guide-Snapshots-Preview_Snapshot" class="imageblock">
<div class="content">
<img src="1002.png" alt="1002">
</div>
<div class="title">Figure 3. Preview Snapshot</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="Snapshot_Deletion">Snapshot Deletion</h2>
<div class="sectionbody">
<div class="paragraph">
<p>You can delete individual snapshots that are no longer required. Deleting a snapshot removes the ability to restore a virtual disk to that particular restoration point. It does not necessarily reclaim the disk space consumed by the snapshot, nor does it delete the data. The disk space will only be reclaimed if a subsequent snapshot has overwritten the data of the deleted snapshot. For example, if the third snapshot out of five snapshots is deleted, the unchanged data in the third snapshot must be preserved on the disk for the fourth and fifth snapshots to be usable; however, if the fourth or fifth snapshot has overwritten the data of the third, then the third snapshot has been made redundant and the disk space can be reclaimed. Aside from potential disk space reclamation, deleting a snapshot may also improve the performance of the virtual machine.</p>
</div>
<div id="figu-Technical_Reference_Guide-Snapshots-Snapshot_Deletion" class="imageblock">
<div class="content">
<img src="993.png" alt="993">
</div>
<div class="title">Figure 4. Snapshot Deletion</div>
</div>
<div class="paragraph">
<p>Snapshot deletion is handled as an asynchronous block job in which VDSM maintains a record of the operation in the recovery file for the virtual machine so that the job can be tracked even if VDSM is restarted or the virtual machine is shut down during the operation. Once the operation begins, the snapshot being deleted cannot be previewed or used as a restoration point, even if the operation fails or is interrupted. In operations in which the active layer is to be merged with its parent, the operation is split into a two-stage process during which data is copied from the active layer to the parent layer, and disk writes are mirrored to both the active layer and the parent. Finally, the job is considered complete once the data in the snapshot being deleted has been merged with its parent snapshot and VDSM synchronizes the changes throughout the image chain.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If the deletion fails, fix the underlying problem (for example, a failed host, an inaccessible storage device, or even a temporary network issue) and try again.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>



        </section>
      </section>
    </main>

    <script src="/ovirt-site/previews/2771/javascripts/lib/headings_anchors.js" type="text/javascript"></script><footer class='text-center' id='footer'><hr class='visible-print'><ul class='footer-nav-list'><li><a href='/ovirt-site/previews/2771/privacy-policy.html' target='_blank' title='Privacy policy'>Privacy policy</a></li><li><a href='/ovirt-site/previews/2771/community/about.html' target='_blank' title='About'>About</a></li><li><a href='/ovirt-site/previews/2771/general-disclaimer.html' target='_blank' title='Disclaimers'>Disclaimers</a></li></ul>&copy; 2013&ndash;2022 oVirt<div class='edit-this-page'><a href='https://github.com/oVirt/ovirt-site/issues/new?labels=documentation&amp;title=Issue:%20/documentation/doc-Technical_Reference/chap-Virtual_Machine_Snapshots.html&amp;template=issue_template_documentation.md' target='_blank' title='Report an issue'><i class="icon fab fa-github"></i>Report an issue with this page</a></div><div class='edit-this-page'><a href='https://github.com/oVirt/ovirt-site/edit/master/source/documentation/doc-Technical_Reference/chap-Virtual_Machine_Snapshots.adoc' target='_blank' title='Edit this page'><i class="icon fab fa-github"></i>Edit this page</a></div></footer></body>

</html>
